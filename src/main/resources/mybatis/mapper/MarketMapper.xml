<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rebirth.my.market.MarketDao">

    <!-- 명시적 매핑을 위한 ResultMap 정의 -->
    <resultMap id="MarketItemResultMap" type="com.rebirth.my.domain.MarketVo">
        <id property="id" column="ID" />
        <result property="userId" column="USER_ID" />
        <result property="sellerName" column="SELLER_NAME" />
        <result property="sellerAddress" column="SELLER_ADDRESS" />
        <result property="name" column="NAME" />
        <result property="category" column="CATEGORY" />
        <result property="detailDesc" column="DETAIL_DESC" />
        <result property="targetPrice" column="TARGET_PRICE" />
        <result property="status" column="STATUS" />
        <result property="imageUrl" column="IMAGE_URL" />
        <result property="isForSale" column="IS_FOR_SALE" />
        <result property="createdAt" column="CREATED_AT" />
        <result property="wishCount" column="WISH_COUNT" />
        <result property="wished" column="IS_WISHED" javaType="boolean" jdbcType="NUMERIC" />
        <result property="tradeLocation" column="TRADE_LOCATION" />
        <result property="latitude" column="LATITUDE" />
        <result property="longitude" column="LONGITUDE" />
    </resultMap>

    <!-- 1. 판매 상품 등록 (옷장 테이블에 추가) -->
    <insert id="insertClothingItem" parameterType="com.rebirth.my.domain.MarketVo">
        <selectKey keyProperty="id" resultType="long" order="BEFORE">
            SELECT S_CLOTHING_ITEMS.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO CLOTHING_ITEMS (
            ID,
            USER_ID,
            NAME,
            DETAIL_DESC,
            TARGET_PRICE,
            TRADE_LOCATION,
            LATITUDE,
            LONGITUDE,
            STATUS,
            IS_FOR_SALE,
            CREATED_AT
        ) VALUES (
            #{id},
            #{userId},
            #{name},
            #{detailDesc},
            #{targetPrice, jdbcType=NUMERIC},
            #{tradeLocation, jdbcType=VARCHAR},
            #{latitude, jdbcType=NUMERIC},
            #{longitude, jdbcType=NUMERIC},
            'IN_CLOSET',
            'Y',
            SYSTIMESTAMP
        )
    </insert>

    <!-- 2. 이미지 등록 -->
    <insert id="insertClothingImage" parameterType="com.rebirth.my.domain.MarketVo">
        INSERT INTO CLOTHING_IMAGES (
            CLOTHING_ITEM_ID,
            IMAGE_URL,
            IS_MAIN,
            CREATED_AT
        ) VALUES (
            #{id},
            #{imageUrl, jdbcType=VARCHAR},
            'Y',
            SYSTIMESTAMP
        )
    </insert>

    <!-- 3. 판매 목록 조회 (ResultMap 사용) - 판매자 주소 포함 -->
    <select id="selectMarketList" resultMap="MarketItemResultMap">
        SELECT 
            C.ID,
            C.USER_ID,
            U.NAME AS SELLER_NAME,
            U.ADDRESS AS SELLER_ADDRESS,
            C.NAME,
            C.CATEGORY,
            C.DETAIL_DESC,
            C.TARGET_PRICE,
            C.TRADE_LOCATION,
            C.LATITUDE,
            C.LONGITUDE,
            C.STATUS,
            C.IS_FOR_SALE,
            C.CREATED_AT,
            (SELECT IMAGE_URL FROM (
                SELECT IMAGE_URL FROM CLOTHING_IMAGES 
                WHERE CLOTHING_ITEM_ID = C.ID 
                ORDER BY CASE WHEN IS_MAIN = 'Y' THEN 0 ELSE 1 END, CREATED_AT ASC
            ) WHERE ROWNUM = 1) AS IMAGE_URL,
            (SELECT COUNT(*) FROM CLOTHING_FAVORITES WHERE CLOTHING_ITEM_ID = C.ID) AS WISH_COUNT,
            (SELECT COUNT(*) FROM CLOTHING_FAVORITES WHERE CLOTHING_ITEM_ID = C.ID AND USER_ID = #{userId}) AS IS_WISHED
        FROM CLOTHING_ITEMS C
        JOIN USERS U ON C.USER_ID = U.ID
        WHERE C.IS_FOR_SALE = 'Y'
        ORDER BY C.CREATED_AT DESC
    </select>

    <!-- 4. 상세 조회 (ResultMap 사용) -->
    <select id="selectMarketItemDetail" parameterType="long" resultMap="MarketItemResultMap">
        SELECT 
            C.ID,
            C.USER_ID,
            U.NAME AS SELLER_NAME,
            C.NAME,
            C.CATEGORY,
            C.DETAIL_DESC,
            C.TARGET_PRICE,
            C.STATUS,
            C.IS_FOR_SALE,
            C.CREATED_AT,
            C.TRADE_LOCATION,
            C.LATITUDE,
            C.LONGITUDE,
            (SELECT IMAGE_URL FROM CLOTHING_IMAGES WHERE CLOTHING_ITEM_ID = C.ID AND CLOTHING_IMAGES.IS_MAIN = 'Y' AND ROWNUM = 1) AS IMAGE_URL
        FROM CLOTHING_ITEMS C
        JOIN USERS U ON C.USER_ID = U.ID
        WHERE C.ID = #{id}
    </select>

    <!-- 5. 판매 취소 (삭제) -->
    <update id="cancelSale">
        UPDATE CLOTHING_ITEMS 
        SET IS_FOR_SALE = 'N', STATUS = 'IN_CLOSET'
        WHERE ID = #{id} AND USER_ID = #{userId}
    </update>

    <!-- 5-1. 옷장에서 판매하기 (기존 옷 상태 업데이트) -->
    <update id="updateClothesForSale" parameterType="com.rebirth.my.domain.MarketVo">
        UPDATE CLOTHING_ITEMS 
        SET IS_FOR_SALE = 'Y', 
            NAME = #{name, jdbcType=VARCHAR},
            TARGET_PRICE = #{targetPrice, jdbcType=NUMERIC},
            DETAIL_DESC = #{detailDesc, jdbcType=VARCHAR},
            TRADE_LOCATION = #{tradeLocation, jdbcType=VARCHAR},
            LATITUDE = #{latitude, jdbcType=NUMERIC},
            LONGITUDE = #{longitude, jdbcType=NUMERIC}
        WHERE ID = #{clothesId} AND USER_ID = #{userId}
    </update>

    <!-- 6. 찜하기 -->
    <insert id="insertWish">
        INSERT INTO CLOTHING_FAVORITES (ID, USER_ID, CLOTHING_ITEM_ID, CREATED_AT)
        VALUES (S_CLOTHING_FAVORITES.NEXTVAL, #{userId}, #{marketId}, SYSTIMESTAMP)
    </insert>

    <!-- 7. 찜 취소 -->
    <delete id="deleteWish">
        DELETE FROM CLOTHING_FAVORITES
        WHERE USER_ID = #{userId} AND CLOTHING_ITEM_ID = #{marketId}
    </delete>

    <!-- 8. 찜 여부 확인 -->
    <select id="checkWishExists" resultType="int">
        SELECT COUNT(*)
        FROM CLOTHING_FAVORITES
        WHERE USER_ID = #{userId} AND CLOTHING_ITEM_ID = #{marketId}
    </select>

    <!-- 9. 찜 개수 조회 -->
    <select id="countWishes" resultType="int">
        SELECT COUNT(*)
        FROM CLOTHING_FAVORITES
        WHERE CLOTHING_ITEM_ID = #{marketId}
    </select>

    <!-- 10. 상품 정보 수정 -->
    <update id="updateMarketItem" parameterType="com.rebirth.my.domain.MarketVo">
        UPDATE CLOTHING_ITEMS 
        SET NAME = #{name, jdbcType=VARCHAR},
            TARGET_PRICE = #{targetPrice, jdbcType=NUMERIC},
            DETAIL_DESC = #{detailDesc, jdbcType=VARCHAR},
            TRADE_LOCATION = #{tradeLocation, jdbcType=VARCHAR},
            LATITUDE = #{latitude, jdbcType=NUMERIC},
            LONGITUDE = #{longitude, jdbcType=NUMERIC}
        WHERE ID = #{id} AND USER_ID = #{userId}
    </update>

    <!-- 10-1. 상품 상태 변경 (판매완료 처리 등) -->
    <update id="updateStatus">
        UPDATE CLOTHING_ITEMS
        SET STATUS = #{status}
        WHERE ID = #{id} AND USER_ID = #{userId}
    </update>

    <!-- 11. 추가 이미지 등록 (IS_MAIN = 'N') -->
    <insert id="insertAdditionalImage">
        INSERT INTO CLOTHING_IMAGES (
            CLOTHING_ITEM_ID,
            IMAGE_URL,
            IS_MAIN,
            CREATED_AT
        ) VALUES (
            #{clothingItemId},
            #{imageUrl},
            'N',
            SYSTIMESTAMP
        )
    </insert>

    <!-- 12. 추가 이미지 목록 조회 -->
    <select id="selectAdditionalImages" parameterType="long" resultType="string">
        SELECT IMAGE_URL 
        FROM CLOTHING_IMAGES 
        WHERE CLOTHING_ITEM_ID = #{clothingItemId} AND IS_MAIN = 'N'
        ORDER BY CREATED_AT ASC
    </select>

    <!-- 13. 추가 이미지 삭제 (상품 수정 시) -->
    <delete id="deleteAdditionalImages" parameterType="long">
        DELETE FROM CLOTHING_IMAGES 
        WHERE CLOTHING_ITEM_ID = #{clothingItemId} AND IS_MAIN = 'N'
    </delete>

</mapper>

