<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.rebirth.my.notice.NoticeDao">

    <insert id="insertNotice" parameterType="com.rebirth.my.notice.NoticeVo">
        /* NoticeDao.insertNotice */
        INSERT INTO POSTS (
            ID, CATEGORY, TITLE, CONTENT, USER_ID, CREATED_AT, VIEW_COUNT, IS_SECRET, IS_DELETED
        ) VALUES (
            (SELECT NVL(MAX(ID), 0) + 1 FROM POSTS), #{category}, #{title}, #{content}, #{userId}, SYSDATE, 0, NVL(#{isSecret}, 'N'), 'N'
        )
    </insert>

    <select id="selectNoticeList" resultType="com.rebirth.my.notice.NoticeVo">
        /* NoticeDao.selectNoticeList */
        SELECT
            P.ID as id,
            P.CATEGORY,
            P.TITLE,
            NVL(UP.NICKNAME, '관리자') as writer,
            P.USER_ID as userId,
            P.CREATED_AT,
            P.VIEW_COUNT as viewCount,
            P.IS_SECRET
        FROM POSTS P
        LEFT JOIN USER_PROFILES UP ON P.USER_ID = UP.USER_ID
        WHERE P.IS_DELETED = 'N'
        ORDER BY P.ID DESC
    </select>
    
    <select id="selectNoticeDetail" parameterType="int" resultType="com.rebirth.my.notice.NoticeVo">
        /* NoticeDao.selectNoticeDetail */
        SELECT
            P.ID as id,
            P.CATEGORY,
            P.TITLE,
            P.CONTENT,
            NVL(UP.NICKNAME, '관리자') as writer,
            P.USER_ID as userId,
            P.CREATED_AT,
            P.VIEW_COUNT as viewCount,
            P.IS_SECRET,
            P.ANSWER,
            P.ANSWERED_AT as answeredAt
        FROM POSTS P
        LEFT JOIN USER_PROFILES UP ON P.USER_ID = UP.USER_ID
        WHERE P.ID = #{id} AND P.IS_DELETED = 'N'
    </select>

    <update id="updateNotice" parameterType="com.rebirth.my.notice.NoticeVo">
        /* NoticeDao.updateNotice */
        UPDATE POSTS
        SET
            TITLE = #{title},
            CONTENT = #{content},
            CATEGORY = #{category},
            IS_SECRET = #{isSecret, jdbcType=VARCHAR}
        WHERE ID = #{id}
    </update>

    <update id="deleteNotice" parameterType="int">
        /* NoticeDao.deleteNotice */
        UPDATE POSTS
        SET IS_DELETED = 'Y'
        WHERE ID = #{id}
    </update>

    <update id="increaseViewCount" parameterType="int">
        /* NoticeDao.increaseViewCount */
        UPDATE POSTS
        SET VIEW_COUNT = VIEW_COUNT + 1
        WHERE ID = #{id}
    </update>
    <update id="updateNoticeAnswer" parameterType="com.rebirth.my.notice.NoticeVo">
        /* NoticeDao.updateNoticeAnswer */
        UPDATE POSTS
        SET
            ANSWER = #{answer},
            ANSWERED_AT = SYSDATE
        WHERE ID = #{id}
    </update>
</mapper>
