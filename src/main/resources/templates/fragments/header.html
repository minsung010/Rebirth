<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<header th:fragment="headerFragment"
    class="fixed top-0 left-0 right-0 z-50 flex w-full items-center justify-center border-b border-border-light dark:border-border-dark shadow-sm h-20"
    id="main-header">
    <!-- 배경 레이어 - 메가 메뉴(z-40)보다 높음 -->
    <div class="absolute inset-0 bg-card-light/95 dark:bg-card-dark/95 backdrop-blur-md z-[45]"></div>

    <div class="flex items-center justify-between w-full max-w-7xl px-4 py-3 relative z-50">

        <!-- Left Side: Mobile Menu Button & Logo -->
        <div class="flex items-center gap-4">
            <!-- Mobile Menu Button (Moved to Left) -->
            <button id="mobile-menu-btn"
                class="xl:hidden flex items-center justify-center size-10 rounded-full bg-card-light dark:bg-card-dark border border-border-light dark:border-border-dark text-text-light dark:text-text-dark hover:bg-gray-100 dark:hover:bg-gray-800 transition-colors">
                <span class="material-symbols-outlined">menu</span>
            </button>

            <!-- Logo -->
            <a href="/main" class="flex items-center gap-4 shrink-0 cursor-pointer group" data-scene-trigger="top">
                <div class="size-8 text-primary group-hover:scale-110 transition-transform duration-300">
                    <svg fill="none" viewBox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
                        <g clip-path="url(#clip0_6_319)">
                            <path
                                d="M8.57829 8.57829C5.52816 11.6284 3.451 15.5145 2.60947 19.7452C1.76794 23.9758 2.19984 28.361 3.85056 32.3462C5.50128 36.3314 8.29667 39.7376 11.8832 42.134C15.4698 44.5305 19.6865 45.8096 24 45.8096C28.3135 45.8096 32.5302 44.5305 36.1168 42.134C39.7033 39.7375 42.4987 36.3314 44.1494 32.3462C45.8002 28.361 46.2321 23.9758 45.3905 19.7452C44.549 15.5145 42.4718 11.6284 39.4217 8.57829L24 24L8.57829 8.57829Z"
                                fill="currentColor"></path>
                            <path d="M24 2.19043L39.4217 17.6121L24 33.0338L8.57829 17.6121L24 2.19043Z"
                                stroke="currentColor" stroke-width="3"></path>
                        </g>
                        <defs>
                            <clipPath id="clip0_6_319">
                                <rect fill="white" height="48" width="48"></rect>
                            </clipPath>
                        </defs>
                    </svg>
                </div>

                <div class="font-bold text-lg overflow-hidden h-8 w-24 relative">
                    <div class="logo-track">
                        <div class="h-8 leading-[32px] whitespace-nowrap">리버스</div>
                        <div class="h-8 leading-[32px] whitespace-nowrap font-display tracking-tight">Re:birth</div>
                    </div>
                </div>
            </a>
        </div>

        <!-- Desktop Nav -->
        <nav class="hidden xl:flex items-center h-full absolute left-1/2 -translate-x-1/2 peer" data-mega-menu="true">
            <div class="flex items-center justify-center h-full px-4 relative z-50">
                <a href="/analysis"
                    class="text-base font-bold text-text-light dark:text-text-dark hover:text-primary py-4 transition-colors relative w-40 flex items-center justify-center text-center">AI
                    옷 분류/분석</a>
                <a href="/market/list"
                    class="text-base font-bold text-text-light dark:text-text-dark hover:text-primary py-4 transition-colors relative w-40 flex items-center justify-center text-center">Re:Store</a>
                <a href="/wardrobe"
                    class="text-base font-bold text-text-light dark:text-text-dark hover:text-primary py-4 transition-colors relative w-32 flex items-center justify-center text-center">옷장</a>
                <a href="/chat"
                    class="text-base font-bold text-text-light dark:text-text-dark hover:text-primary py-4 transition-colors relative w-40 flex items-center justify-center text-center">
                    <span class="relative">
                        채팅
                        <span id="header-chat-badge"
                            class="hidden absolute -top-2 -right-6 flex h-4 min-w-[1rem] items-center justify-center rounded-full bg-red-500 px-1 text-[10px] font-bold text-white shadow-sm ring-1 ring-white dark:ring-gray-900 leading-none">
                        </span>
                    </span>
                </a>

                <a href="/community"
                    class="text-base font-bold text-text-light dark:text-text-dark hover:text-primary py-4 transition-colors relative w-32 flex items-center justify-center text-center">커뮤니티</a>
            </div>
        </nav>

        <!-- Buttons -->
        <div class="flex gap-2 shrink-0">
            <!-- Anonymous Users -->
            <div sec:authorize="isAnonymous()" class="flex gap-2">
                <a href="/auth/login"
                    class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-card-light dark:bg-card-dark text-sm font-bold border border-border-light dark:border-border-dark hover:bg-violet-100 dark:hover:bg-violet-900/40 transition-colors">
                    <span>로그인</span>
                </a>
                <a href="/auth/join"
                    class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-primary text-white text-sm font-bold hover:opacity-90 transition-opacity">
                    <span>회원가입</span>
                </a>
            </div>

            <!-- Authenticated Users -->
            <div sec:authorize="isAuthenticated()" class="flex gap-3 items-center">
                <!-- Profile Link -->
                <a href="/mypage"
                    class="flex items-center gap-2 hover:bg-card-light dark:hover:bg-card-dark/50 p-1 pr-3 rounded-full transition-colors border border-transparent hover:border-border-light dark:hover:border-border-dark">
                    <div class="size-8 rounded-full border border-border-light dark:border-border-dark overflow-visible relative"
                        th:classappend="${#authentication.principal.user.activeDecoration}">
                        <img th:src="${#authentication.principal.user.memImg != null ? #authentication.principal.user.memImg : 'https://api.dicebear.com/7.x/avataaars/svg?seed=' + #authentication.principal.user.name}"
                            alt="Profile" class="w-full h-full object-cover rounded-full relative z-10"
                            th:data-name="${#authentication.principal.user.name}"
                            onerror="this.onerror=null; this.src='https://ui-avatars.com/api/?name=' + encodeURIComponent(this.getAttribute('data-name')) + '&background=random';">
                    </div>
                    <span class="text-sm font-bold text-text-light dark:text-text-dark"
                        th:text="${#authentication.principal.user.name}">닉네임</span>
                </a>

                <!-- Admin Badge -->
                <span sec:authorize="hasRole('ADMIN')"
                    class="px-3 py-1 rounded-full bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 text-xs font-bold border border-red-200 dark:border-red-800">
                    관리자
                </span>

                <form th:action="@{/logout}" method="post" class="flex items-center"
                    onsubmit="if(typeof clearChatbotHistory === 'function') clearChatbotHistory(); sessionStorage.removeItem('rebirth_chatbot_history');">
                    <button type="submit"
                        class="flex min-w-[84px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 px-4 bg-card-light dark:bg-card-dark text-sm font-bold border border-border-light dark:border-border-dark hover:bg-red-100 dark:hover:bg-red-900/40 transition-colors text-red-500">
                        <span>로그아웃</span>
                    </button>
                </form>
            </div>


        </div>
    </div>

    <!-- Mega Menu - header 직접 자식, 배경 레이어(z-45)보다 아래(z-30) -->
    <div class="absolute top-full w-auto mega-menu-content z-30 hidden xl:block" id="mega-menu-container">
        <div
            class="bg-card-light dark:bg-card-dark border-t border-border-light dark:border-border-dark shadow-xl rounded-b-xl overflow-hidden">
            <div class="py-6">
                <div class="flex justify-center text-left px-4">
                    <!-- Analysis -->
                    <div class="flex flex-col gap-3 w-40 shrink-0 items-center">
                        <div class="flex items-center justify-center gap-2 border-b-2 border-primary pb-2 mb-1 w-full">
                            <span class="material-symbols-outlined text-primary text-lg">checkroom</span>
                            <p class="font-extrabold text-sm text-primary uppercase tracking-wider">AI 옷 분류/분석</p>
                        </div>
                        <a href="/analysis"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">분석하기</a>
                    </div>
                    <!-- Market (Re:Store) -->
                    <div class="flex flex-col gap-3 w-40 shrink-0 items-center">
                        <div class="flex items-center justify-center gap-2 border-b-2 border-primary pb-2 mb-1 w-full">
                            <span class="material-symbols-outlined text-primary text-lg">storefront</span>
                            <p class="font-extrabold text-sm text-primary tracking-wider">Re:Store</p>
                        </div>
                        <a href="/market/list"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">마켓
                            둘러보기</a>
                        <a href="/donation/guide"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">자원
                            순환 기부</a>
                        <a href="/analysis/disposal"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">폐기하기</a>
                    </div>
                    <!-- Wardrobe -->
                    <div class="flex flex-col gap-3 w-32 shrink-0 items-center">
                        <div class="flex items-center justify-center gap-2 border-b-2 border-primary pb-2 mb-1 w-full">
                            <span class="material-symbols-outlined text-primary text-lg">styler</span>
                            <p class="font-extrabold text-sm text-primary uppercase tracking-wider">옷장</p>
                        </div>
                        <a href="/wardrobe"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">나의
                            옷장보기</a>
                        <a href="/ootd/list"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">OOTD</a>
                    </div>
                    <!-- Chat -->
                    <div class="flex flex-col gap-3 w-40 shrink-0 items-center">
                        <div class="flex items-center justify-center gap-2 border-b-2 border-primary pb-2 mb-1 w-full">
                            <span class="material-symbols-outlined text-primary text-lg">forum</span>
                            <p class="font-extrabold text-sm text-primary uppercase tracking-wider">채팅</p>
                        </div>
                        <a href="/chat/list"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">채팅
                            목록</a>
                        <a href="/chat/bot"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">챗봇</a>
                    </div>
                    <!-- Community -->
                    <div class="flex flex-col gap-3 w-32 shrink-0 items-center">
                        <div class="flex items-center justify-center gap-2 border-b-2 border-primary pb-2 mb-1 w-full">
                            <span class="material-symbols-outlined text-primary text-lg">campaign</span>
                            <p class="font-extrabold text-sm text-primary uppercase tracking-wider">커뮤니티</p>
                        </div>
                        <a href="/community?category=NOTICE"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">공지글
                            목록</a>
                        <a href="/community?category=QNA"
                            class="text-sm text-text-light/70 dark:text-text-dark/70 hover:text-primary hover:font-bold transition-all text-center w-full">문의하기</a>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Current User ID for WebSocket -->
    <div sec:authorize="isAuthenticated()">
        <input type="hidden" id="header-current-user-id" th:value="${#authentication.principal.user.id}">
    </div>

    <!-- Mobile Menu Sidebar (Below Header, Left Side) -->
    <div id="mobile-menu"
        class="absolute top-full left-0 w-64 h-[calc(100vh-100%)] z-[100] bg-card-light dark:bg-card-dark border-r border-border-light dark:border-border-dark flex-col shadow-xl overflow-y-auto hidden">
        <!-- Drawer Header -->


        <!-- Drawer Content -->
        <div class="flex flex-col p-4 w-full">
            <!-- AI 옷 분류/분석 -->
            <div class="border-b border-gray-100 dark:border-gray-800">
                <button type="button"
                    class="mobile-menu-toggle py-4 w-full text-lg font-bold flex items-center justify-between"
                    data-target="mobile-analysis-submenu">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">checkroom</span> AI 옷 분류/분석
                    </div>
                    <span
                        class="material-symbols-outlined text-gray-400 transition-transform duration-300 toggle-arrow">expand_more</span>
                </button>
                <div id="mobile-analysis-submenu" class="mobile-submenu hidden flex-col gap-2 pl-8 pb-3">
                    <a href="/analysis"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 분석하기
                    </a>
                </div>
            </div>

            <!-- Re:Store -->
            <div class="border-b border-gray-100 dark:border-gray-800">
                <button type="button"
                    class="mobile-menu-toggle py-4 w-full text-lg font-bold flex items-center justify-between"
                    data-target="mobile-store-submenu">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">storefront</span>
                        <span class="text-primary tracking-wider">Re:Store</span>
                    </div>
                    <span
                        class="material-symbols-outlined text-gray-400 transition-transform duration-300 toggle-arrow">expand_more</span>
                </button>
                <div id="mobile-store-submenu" class="mobile-submenu hidden flex-col gap-2 pl-8 pb-3">
                    <a href="/market/list"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 마켓 둘러보기
                    </a>
                    <a href="/donation/guide"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 자원 순환 기부
                    </a>
                    <a href="/analysis/disposal"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 폐기하기
                    </a>
                </div>
            </div>

            <!-- 옷장 -->
            <div class="border-b border-gray-100 dark:border-gray-800">
                <button type="button"
                    class="mobile-menu-toggle py-4 w-full text-lg font-bold flex items-center justify-between"
                    data-target="mobile-wardrobe-submenu">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">styler</span> 옷장
                    </div>
                    <span
                        class="material-symbols-outlined text-gray-400 transition-transform duration-300 toggle-arrow">expand_more</span>
                </button>
                <div id="mobile-wardrobe-submenu" class="mobile-submenu hidden flex-col gap-2 pl-8 pb-3">
                    <a href="/wardrobe"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 나의 옷장보기
                    </a>
                    <a href="/ootd/list"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> OOTD
                    </a>
                </div>
            </div>

            <!-- 채팅 -->
            <div class="border-b border-gray-100 dark:border-gray-800">
                <button type="button"
                    class="mobile-menu-toggle py-4 w-full text-lg font-bold flex items-center justify-between"
                    data-target="mobile-chat-submenu">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">forum</span> 채팅
                        <span id="mobile-chat-badge"
                            class="hidden flex h-5 min-w-[1.25rem] items-center justify-center rounded-full bg-red-500 px-1.5 text-xs font-bold text-white"></span>
                    </div>
                    <span
                        class="material-symbols-outlined text-gray-400 transition-transform duration-300 toggle-arrow">expand_more</span>
                </button>
                <div id="mobile-chat-submenu" class="mobile-submenu hidden flex-col gap-2 pl-8 pb-3">
                    <a href="/chat/list"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 채팅 목록
                    </a>
                    <a href="/chat/bot"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 챗봇
                    </a>
                </div>
            </div>

            <!-- 커뮤니티 -->
            <div class="border-b border-gray-100 dark:border-gray-800">
                <button type="button"
                    class="mobile-menu-toggle py-4 w-full text-lg font-bold flex items-center justify-between"
                    data-target="mobile-community-submenu">
                    <div class="flex items-center gap-3">
                        <span class="material-symbols-outlined text-primary">campaign</span>
                        <span class="uppercase tracking-wider">커뮤니티</span>
                    </div>
                    <span
                        class="material-symbols-outlined text-gray-400 transition-transform duration-300 toggle-arrow">expand_more</span>
                </button>
                <div id="mobile-community-submenu" class="mobile-submenu hidden flex-col gap-2 pl-8 pb-3">
                    <a href="/community?category=NOTICE"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 공지글 목록
                    </a>
                    <a href="/community?category=QNA"
                        class="py-2 text-base font-medium flex items-center gap-2 text-text-light/80 dark:text-text-dark/80">
                        <span class="size-1 rounded-full bg-gray-400"></span> 문의하기
                    </a>
                </div>
            </div>

        </div>
    </div>

    <script>
        const mobileMenuBtn = document.getElementById('mobile-menu-btn');
        const mobileMenu = document.getElementById('mobile-menu');

        if (mobileMenuBtn && mobileMenu) {
            mobileMenuBtn.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });

            // Close menu when clicking outside
            document.addEventListener('click', (e) => {
                if (!mobileMenu.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });

            // Mobile Accordion Menu Toggle
            const mobileMenuToggles = document.querySelectorAll('.mobile-menu-toggle');
            mobileMenuToggles.forEach(toggle => {
                toggle.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = toggle.getAttribute('data-target');
                    const submenu = document.getElementById(targetId);
                    const arrow = toggle.querySelector('.toggle-arrow');

                    if (submenu) {
                        // Toggle visibility
                        const isHidden = submenu.classList.contains('hidden');

                        if (isHidden) {
                            // Show submenu
                            submenu.classList.remove('hidden');
                            submenu.classList.add('flex');
                            if (arrow) arrow.style.transform = 'rotate(180deg)';
                        } else {
                            // Hide submenu
                            submenu.classList.add('hidden');
                            submenu.classList.remove('flex');
                            if (arrow) arrow.style.transform = 'rotate(0deg)';
                        }
                    }
                });
            });
        }

        // ==========================================
        // Real-time Notification Logic
        // ==========================================

        // Load SockJS and Stomp dynamically if not present
        function loadScript(src, callback) {
            if (document.querySelector('script[src="' + src + '"]')) {
                callback();
                return;
            }
            var script = document.createElement('script');
            script.src = src;
            script.onload = callback;
            document.head.appendChild(script);
        }

        // Service Worker 등록
        let swRegistration = null;
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('/sw.js')
                .then(function (registration) {
                    swRegistration = registration;
                })
                .catch(function (error) {
                    console.error('Service Worker 등록 실패:', error);
                });
        }

        // Browser Notification (모바일 + 데스크톱 호환)
        function showNotification(title, body, url, roomId) {
            if (!("Notification" in window) || Notification.permission !== "granted") {
                return;
            }

            const tag = 'chat-room-' + roomId; // 채팅방별 고유 태그

            // Service Worker가 있으면 SW 방식 사용 (모바일 호환)
            if (swRegistration) {
                swRegistration.showNotification(title, {
                    body: body,
                    icon: '/images/fav.png',
                    badge: '/images/fav.png',
                    vibrate: [200, 100, 200],
                    tag: tag, // 같은 tag면 기존 알림을 대체
                    renotify: true, // 같은 tag여도 다시 알림
                    data: { url: url, roomId: roomId }
                }).catch(function (e) {
                    // 폴백: 데스크톱 방식 시도
                    tryDesktopNotification(title, body, url, tag);
                });
            } else {
                // Service Worker 없으면 데스크톱 방식 시도
                tryDesktopNotification(title, body, url, tag);
            }
        }

        // 특정 채팅방의 알림 닫기
        function closeNotificationsForRoom(roomId) {
            if (!swRegistration) return;

            const tag = 'chat-room-' + roomId;
            swRegistration.getNotifications({ tag: tag }).then(function (notifications) {
                notifications.forEach(function (notification) {
                    notification.close();
                });
            });
        }

        function tryDesktopNotification(title, body, url, tag) {
            try {
                const notification = new Notification(title, {
                    body: body,
                    icon: '/images/fav.png',
                    tag: tag
                });
                notification.onclick = function () {
                    window.location.href = url;
                    notification.close();
                };
            } catch (e) {
                // 모바일에서는 지원 안 됨
            }
        }

        function updateUnreadCount() {
            fetch('/chat/api/unread-count')
                .then(response => {
                    if (response.ok) return response.json();
                    throw new Error('Network response was not ok');
                })
                .then(count => {
                    const badge = document.getElementById('header-chat-badge');
                    const mobileBadge = document.getElementById('mobile-chat-badge');

                    if (count > 0) {
                        const countText = count > 99 ? '99+' : count;
                        if (badge) {
                            badge.textContent = countText;
                            badge.classList.remove('hidden');
                        }
                        if (mobileBadge) {
                            mobileBadge.textContent = countText;
                            mobileBadge.classList.remove('hidden');
                        }
                    } else {
                        if (badge) badge.classList.add('hidden');
                        if (mobileBadge) mobileBadge.classList.add('hidden');
                    }
                })
                .catch(error => {
                    // Silent fail
                });
        }

        document.addEventListener("DOMContentLoaded", function () {
            // 1. Initial Fetch
            updateUnreadCount();

            // Request Notification Permission
            if ("Notification" in window && Notification.permission !== "granted") {
                Notification.requestPermission();
            }

            // 2. WebSocket Connection for Real-time Updates
            const userIdInput = document.getElementById('header-current-user-id');
            const userId = userIdInput ? userIdInput.value : null;

            // 현재 채팅방에 있으면 해당 알림 닫기
            const urlParams = new URLSearchParams(window.location.search);
            const currentRoomId = urlParams.get('roomId');
            if (currentRoomId) {
                // Service Worker 준비 후 알림 닫기
                setTimeout(function () {
                    closeNotificationsForRoom(currentRoomId);
                }, 1000);
            }

            if (userId) {
                const initWebSocket = () => {
                    loadScript("https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js", function () {
                        loadScript("https://cdnjs.cloudflare.com/ajax/libs/stomp.js/2.3.3/stomp.min.js", function () {

                            const socket = new SockJS('/ws');
                            const stompClient = Stomp.over(socket);
                            stompClient.debug = null;

                            stompClient.connect({}, function (frame) {
                                stompClient.subscribe('/topic/user/' + userId + '/chat', function (message) {
                                    updateUnreadCount();

                                    try {
                                        const body = JSON.parse(message.body);

                                        if (body.type === 'CHAT' && body.roomId && body.senderId != userId) {
                                            const urlParams = new URLSearchParams(window.location.search);
                                            const currentRoomId = urlParams.get('roomId');

                                            if (currentRoomId != body.roomId) {
                                                showNotification("새 메시지 도착", body.content, "/chat/room?roomId=" + body.roomId, body.roomId);
                                            }
                                        }

                                        // READ 메시지를 받으면 해당 방 알림 닫기
                                        if (body.type === 'READ' && body.roomId) {
                                            closeNotificationsForRoom(body.roomId);
                                        }
                                    } catch (e) {
                                        // Silent fail
                                    }
                                });
                            }, function (error) {
                                setTimeout(initWebSocket, 5000);
                            });
                        });
                    });
                };

                try {
                    initWebSocket();
                } catch (e) {
                    console.error('WebSocket Init Failed:', e);
                }
            }
        });
    </script>
</header>

</html>