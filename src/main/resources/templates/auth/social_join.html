<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: headFragment}"></head>

<body
    class="font-display bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark min-h-screen flex flex-col">

    <!-- Header -->
    <header th:replace="~{fragments/header :: headerFragment}"></header>

    <!-- Main Content -->
    <main class="flex-grow flex items-center justify-center py-24 px-4">
        <div class="w-full max-w-lg animate-fade-in-up">

            <div
                class="bg-card-light dark:bg-card-dark rounded-3xl p-8 border border-border-light dark:border-border-dark shadow-xl relative overflow-hidden">
                <!-- Decorative Background -->
                <div
                    class="absolute bottom-0 left-0 w-64 h-64 bg-secondary/5 rounded-full blur-3xl translate-y-1/2 -translate-x-1/2">
                </div>

                <!-- Logo & Title -->
                <div class="text-center mb-8 relative">
                    <h1 class="text-2xl font-bold">ì†Œì…œ íšŒì›ê°€ì…</h1>
                    <p class="text-text-light/60 dark:text-text-dark/60 text-sm mt-1">ì¶”ê°€ ì •ë³´ë¥¼ ì…ë ¥í•˜ì—¬ ê°€ì…ì„ ì™„ë£Œí•˜ì„¸ìš”.</p>
                </div>

                <!-- Join Form -->
                <form class="space-y-5 relative" action="/auth/social-join" method="post"
                    onsubmit="return validateForm()">

                    <!-- Name -->
                    <div class="space-y-1">
                        <label for="nickname"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ì´ë¦„</label>
                        <input type="text" id="nickname" name="nickname" th:value="${name}" placeholder="ì´ë¦„" required
                            class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                    </div>

                    <!-- BirthDate (YYYYMMDD) & Gender -->
                    <div class="flex gap-4">
                        <div class="space-y-1 w-2/3">
                            <label for="birthDateString"
                                class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ìƒë…„ì›”ì¼ 8ìë¦¬ (ì˜ˆì‹œ:
                                20010508)</label>
                            <input type="text" id="birthDateString" name="birthDateString" placeholder="20010508"
                                maxlength="8" required
                                class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                        </div>
                        <div class="space-y-1 w-1/3">
                            <label
                                class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1 text-center block">ì„±ë³„</label>
                            <div class="flex items-center justify-center gap-4 h-12">
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="gender" value="MALE" checked
                                        class="accent-primary w-5 h-5">
                                    <span class="text-sm font-bold">ë‚¨ì</span>
                                </label>
                                <label class="flex items-center gap-2 cursor-pointer">
                                    <input type="radio" name="gender" value="FEMALE" class="accent-primary w-5 h-5">
                                    <span class="text-sm font-bold">ì—¬ì</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Email & Verification -->
                    <div class="space-y-2">
                        <label for="email"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ì´ë©”ì¼</label>
                        <div class="flex gap-2">
                            <input type="email" id="email" name="email" th:value="${email}"
                                placeholder="example@rebirth.com" required
                                class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                            <button type="button" onclick="sendVerificationCode()"
                                class="px-4 h-12 bg-primary/10 text-primary font-bold rounded-xl hover:bg-primary/20 transition-colors whitespace-nowrap">
                                ì¸ì¦ë²ˆí˜¸ ì „ì†¡
                            </button>
                        </div>
                        <div class="flex gap-2" id="verificationArea" style="display:none;">
                            <div class="relative w-full">
                                <input type="text" id="verificationCode" placeholder="ì¸ì¦ë²ˆí˜¸ ì…ë ¥"
                                    class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                                <span id="timer"
                                    class="absolute right-4 top-1/2 -translate-y-1/2 text-sm text-red-500 font-bold z-10"></span>
                            </div>
                            <button type="button" onclick="verifyCode()"
                                class="px-4 h-12 bg-secondary/10 text-secondary font-bold rounded-xl hover:bg-secondary/20 transition-colors whitespace-nowrap">
                                í™•ì¸
                            </button>
                        </div>
                        <p id="verificationMsg"
                            class="text-xs ml-1 font-bold text-text-light/60 dark:text-text-dark/60"></p>
                        <input type="hidden" id="isEmailVerified" value="false">
                    </div>

                    <!-- Login ID -->
                    <div class="space-y-1">
                        <label for="loginId"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ì•„ì´ë””</label>
                        <div class="flex gap-2">
                            <input type="text" id="loginId" name="loginId"
                                placeholder="5-20ì, ì˜ë¬¸ ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì (-), (_)ë§Œ ì‚¬ìš©" required
                                class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                            <div id="duplicateCheckButton"
                                class="hidden px-4 h-12 bg-gray-100 dark:bg-gray-800 rounded-xl flex items-center justify-center font-bold text-sm whitespace-nowrap">
                                ì¤‘ë³µí™•ì¸</div>
                        </div>
                        <p id="idErrorMsg" class="text-xs ml-1 text-red-500 font-bold hidden"></p>
                    </div>

                    <!-- Password -->
                    <div class="space-y-1">
                        <label for="password"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ë¹„ë°€ë²ˆí˜¸</label>
                        <input type="password" id="password" name="password" placeholder="ë¹„ë°€ë²ˆí˜¸" required
                            class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                    </div>

                    <div class="space-y-1">
                        <label for="confirm-password"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ë¹„ë°€ë²ˆí˜¸ ì¬í™•ì¸</label>
                        <input type="password" id="confirm-password" placeholder="8-16ì, ì˜ë¬¸ ëŒ€Â·ì†Œë¬¸ì, ìˆ«ì, íŠ¹ìˆ˜ë¬¸ì 2ì¢…ë¥˜ ì´ìƒ ì‚¬ìš©"
                            required
                            class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                    </div>

                    <!-- Phone -->
                    <div class="space-y-1">
                        <label for="phone"
                            class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">íœ´ëŒ€ì „í™”</label>
                        <input type="tel" id="phone" name="phone" placeholder="01012345678" required maxlength="11"
                            class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                    </div>

                    <!-- Address -->
                    <div class="space-y-2">
                        <label class="text-xs font-bold text-text-light/50 dark:text-text-dark/50 ml-1">ì£¼ì†Œ</label>
                        <div class="flex gap-2">
                            <input type="text" id="zipcode" name="zipcode" placeholder="ìš°í¸ë²ˆí˜¸" readonly
                                class="w-32 h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                            <button type="button" onclick="execDaumPostcode()"
                                class="px-4 h-12 bg-secondary/10 text-secondary font-bold rounded-xl hover:bg-secondary/20 transition-colors whitespace-nowrap">
                                ìš°í¸ë²ˆí˜¸ ì°¾ê¸°
                            </button>
                        </div>
                        <input type="text" id="address" name="address" placeholder="ì£¼ì†Œ" readonly
                            class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                        <div class="grid grid-cols-2 gap-2">
                            <input type="text" id="detailAddress" name="detailAddress" placeholder="ìƒì„¸ì£¼ì†Œ"
                                class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                            <input type="text" id="extraAddress" placeholder="ì°¸ê³ í•­ëª©" readonly
                                class="w-full h-12 px-4 rounded-xl bg-background-light dark:bg-background-dark border border-border-light dark:border-border-dark focus:ring-2 focus:ring-primary/50 outline-none transition-all">
                        </div>
                    </div>


                    <button type="submit"
                        class="w-full h-12 bg-primary text-white font-bold rounded-xl shadow-lg shadow-primary/30 hover:bg-primary/90 transition-all hover:scale-[1.02] active:scale-95 mt-8">
                        ê°€ì… ì™„ë£Œ
                    </button>

                </form>
            </div>
        </div>
    </main>

    <!-- Footer -->
    <footer th:replace="~{fragments/footer :: footerFragment}"></footer>

    <!-- Daum Postcode Script -->
    <script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
    <script>
        function execDaumPostcode() {
            new daum.Postcode({
                oncomplete: function (data) {
                    var addr = '';
                    var extraAddr = '';

                    if (data.userSelectedType === 'R') {
                        addr = data.roadAddress;
                    } else {
                        addr = data.jibunAddress;
                    }

                    if (data.userSelectedType === 'R') {
                        if (data.bname !== '' && /[ë™|ë¡œ|ê°€]$/g.test(data.bname)) {
                            extraAddr += data.bname;
                        }
                        if (data.buildingName !== '' && data.apartment === 'Y') {
                            extraAddr += (extraAddr !== '' ? ', ' + data.buildingName : data.buildingName);
                        }
                        if (extraAddr !== '') {
                            extraAddr = ' (' + extraAddr + ')';
                        }
                        document.getElementById("extraAddress").value = extraAddr;
                    } else {
                        document.getElementById("extraAddress").value = '';
                    }

                    document.getElementById('zipcode').value = data.zonecode;
                    document.getElementById("address").value = addr;
                    document.getElementById("detailAddress").focus();
                }
            }).open();
        }

        let timerInterval;

        function startTimer(duration) {
            let timer = duration, minutes, seconds;
            const timerElement = document.getElementById('timer');
            const codeInput = document.getElementById('verificationCode');

            clearInterval(timerInterval);
            codeInput.disabled = false;

            minutes = parseInt(timer / 60, 10);
            seconds = parseInt(timer % 60, 10);
            minutes = minutes < 10 ? "0" + minutes : minutes;
            seconds = seconds < 10 ? "0" + seconds : seconds;
            timerElement.textContent = minutes + ":" + seconds;

            timerInterval = setInterval(function () {
                if (--timer < 0) {
                    clearInterval(timerInterval);
                    timerElement.textContent = "ì‹œê°„ì´ˆê³¼";
                    codeInput.disabled = true;
                    alert("ì¸ì¦ ì‹œê°„ì´ ì´ˆê³¼ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                    return;
                }
                minutes = parseInt(timer / 60, 10);
                seconds = parseInt(timer % 60, 10);
                minutes = minutes < 10 ? "0" + minutes : minutes;
                seconds = seconds < 10 ? "0" + seconds : seconds;
                timerElement.textContent = minutes + ":" + seconds;
            }, 1000);
        }

        function sendVerificationCode() {
            const email = document.getElementById('email').value;
            if (!email) {
                alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            document.getElementById('verificationMsg').innerText = 'ì¸ì¦ë²ˆí˜¸ ì „ì†¡ ì¤‘...';
            document.getElementById('verificationMsg').className = 'text-xs ml-1 text-text-light/60';

            fetch('/api/email/send?email=' + email, {
                method: 'POST'
            })
                .then(async response => {
                    if (response.ok) {
                        document.getElementById('verificationMsg').innerText = 'ì¸ì¦ ì½”ë“œê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ì´ë©”ì¼ì„ í™•ì¸í•´ì£¼ì„¸ìš”.';
                        document.getElementById('verificationMsg').className = 'text-xs ml-1 text-green-500 font-bold';
                        document.getElementById('verificationArea').style.display = 'flex';
                        startTimer(180);
                    } else {
                        const errorMsg = await response.text();
                        document.getElementById('verificationMsg').innerText = 'ì´ë©”ì¼ ë°œì†¡ ì‹¤íŒ¨: ' + errorMsg;
                        document.getElementById('verificationMsg').className = 'text-xs ml-1 text-red-500 font-bold';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: ' + error);
                });
        }

        function verifyCode() {
            const code = document.getElementById('verificationCode').value;
            const email = document.getElementById('email').value; // ì´ë©”ì¼ ê°’ ê°€ì ¸ì˜¤ê¸°
            if (!code) {
                alert('ì¸ì¦ ì½”ë“œë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            fetch('/api/email/verify?code=' + code, {
                method: 'POST'
            })
                .then(response => {
                    if (response.ok) {
                        document.getElementById('verificationMsg').innerText = 'ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                        document.getElementById('verificationMsg').className = 'text-xs ml-1 text-green-500 font-bold';
                        document.getElementById('isEmailVerified').value = 'true';
                        document.getElementById('email').readOnly = true;
                        document.getElementById('verificationArea').style.display = 'none';
                        clearInterval(timerInterval);

                        // ğŸš€ [ì¶”ê°€] ì´ë©”ì¼ ì¤‘ë³µ ì²´í¬ (ê¸°ì¡´ íšŒì› ì—¬ë¶€ í™•ì¸)
                        fetch('/auth/check-email?email=' + email)
                            .then(res => res.json())
                            .then(isExisting => {
                                if (isExisting) {
                                    alert('ê¸°ì¡´ íšŒì›ì´ì‹­ë‹ˆë‹¤. ê³„ì • í†µí•©ì„ ìœ„í•´ í•˜ë‹¨ì˜ [ê°€ì… ì™„ë£Œ] ë²„íŠ¼ì„ ëˆŒëŸ¬ì£¼ì„¸ìš”.');

                                    // 1. ë”ë¯¸ ë°ì´í„° ì£¼ì… (ë°±ì—”ë“œ í†µí•© ë¡œì§ ìˆ˜í–‰ ì‹œ ì´ ê°’ë“¤ì€ ë¬´ì‹œë¨)
                                    document.getElementById('loginId').value = 'merge_' + Date.now();
                                    document.getElementById('password').value = 'MergePass1!';
                                    document.getElementById('confirm-password').value = 'MergePass1!';
                                    document.getElementById('phone').value = '01000000000';

                                    const birthInput = document.getElementById('birthDateString');
                                    if (!birthInput.value) birthInput.value = '20000101';

                                    const nickInput = document.getElementById('nickname');
                                    if (!nickInput.value) nickInput.value = 'í†µí•©íšŒì›';

                                    // ì£¼ì†Œ ë”ë¯¸ ë°ì´í„°
                                    document.getElementById('zipcode').value = '00000';
                                    document.getElementById('address').value = 'ê¸°ì¡´íšŒì›í†µí•©';
                                    document.getElementById('detailAddress').value = 'ê¸°ì¡´íšŒì›í†µí•©';

                                    // 2. ì…ë ¥ í•„ë“œ ìˆ¨ê¸°ê¸° (ì‚¬ìš©ì í˜¼ë€ ë°©ì§€)
                                    function hideContainer(elementId) {
                                        const el = document.getElementById(elementId);
                                        if (el) {
                                            // ê°€ì¥ ê°€ê¹Œìš´ ì»¨í…Œì´ë„ˆ ì°¾ê¸° (space-y-1 ë“±)
                                            const container = el.closest('.space-y-1') || el.closest('.space-y-2');
                                            if (container) container.style.display = 'none';
                                        }
                                    }

                                    hideContainer('loginId');
                                    hideContainer('password');
                                    // confirm-passwordëŠ” ë³„ë„ divì— ìˆìŒ
                                    hideContainer('confirm-password');
                                    hideContainer('phone');
                                    hideContainer('nickname');

                                    // ìƒë…„ì›”ì¼/ì„±ë³„ í–‰ ìˆ¨ê¸°ê¸°
                                    const birthWrapper = document.getElementById('birthDateString').closest('.flex.gap-4');
                                    if (birthWrapper) birthWrapper.style.display = 'none';

                                    // ì£¼ì†Œ ì „ì²´ ìˆ¨ê¸°ê¸°
                                    const addrWrapper = document.getElementById('zipcode').closest('.space-y-2');
                                    if (addrWrapper) addrWrapper.style.display = 'none';
                                }
                            })
                            .catch(err => console.error('ì¤‘ë³µ ì²´í¬ ì‹¤íŒ¨:', err));

                    } else {
                        document.getElementById('verificationMsg').innerText = 'ì¸ì¦ ì½”ë“œê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.';
                        document.getElementById('verificationMsg').className = 'text-xs ml-1 text-red-500 font-bold';
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
        }

        function validateForm() {
            const isVerified = document.getElementById('isEmailVerified').value;
            if (isVerified !== 'true') {
                // To skip verification for testing, you can uncomment below:
                // return true; 
                alert('ì´ë©”ì¼ ì¸ì¦ì„ ì™„ë£Œí•´ì£¼ì„¸ìš”.');
                return false;
            }

            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm-password').value;

            if (password !== confirmPassword) {
                alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return false;
            }

            // BirthDate Validation
            const birthDate = document.getElementById('birthDateString').value;
            if (birthDate.length !== 8) {
                alert('ìƒë…„ì›”ì¼ì€ 8ìë¦¬ë¡œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return false;
            }

            return true;
        }

        document.addEventListener('DOMContentLoaded', function () {
            const loginIdInput = document.getElementById('loginId');
            const idErrorMsg = document.getElementById('idErrorMsg');
            const phoneInput = document.getElementById('phone');

            loginIdInput.addEventListener('blur', function () {
                const loginId = this.value;
                if (!loginId) return;

                fetch('/auth/check-id?loginId=' + loginId)
                    .then(response => response.json())
                    .then(isDuplicate => {
                        if (isDuplicate) {
                            idErrorMsg.innerText = 'ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                            idErrorMsg.classList.remove('hidden');
                            idErrorMsg.classList.remove('text-green-500');
                            idErrorMsg.classList.add('text-red-500');
                        } else {
                            idErrorMsg.innerText = 'ì‚¬ìš© ê°€ëŠ¥í•œ ì•„ì´ë””ì…ë‹ˆë‹¤.';
                            idErrorMsg.classList.remove('hidden', 'text-red-500');
                            idErrorMsg.classList.add('text-green-500');
                        }
                    })
                    .catch(err => console.error(err));
            });

            phoneInput.addEventListener('input', function () {
                this.value = this.value.replace(/[^0-9]/g, '').slice(0, 11);
            });
        });
    </script>
</body>

</html>