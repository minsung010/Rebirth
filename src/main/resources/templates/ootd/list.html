<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">

<head th:replace="~{fragments/head :: headFragment}"></head>

<body class="font-display bg-[#f5f5f5] dark:bg-background-dark text-text-light dark:text-text-dark ootd-page-body">

    <!-- Header -->
    <header th:replace="~{fragments/header :: headerFragment}"></header>

    <!-- Custom Styles for Calendar -->
    <style>
        /* Modern Calendar Styles with Glassmorphism */
        :root {
            --fc-border-color: rgba(229, 231, 235, 0.5);
            --fc-button-text-color: #fff;
            --fc-button-bg-color: #8B5CF6;
            --fc-button-border-color: #7C3AED;
            --fc-button-hover-bg-color: #7C3AED;
            --fc-button-hover-border-color: #6D28D9;
            --fc-button-active-bg-color: #6D28D9;
            --fc-button-active-border-color: #5B21B6;
            --fc-today-bg-color: rgba(139, 92, 246, 0.1) !important;
            --fc-page-bg-color: transparent;
        }

        .dark {
            --fc-border-color: rgba(75, 85, 99, 0.5);
            --fc-today-bg-color: rgba(139, 92, 246, 0.2) !important;
        }

        /* Calendar Container Glass Effect */
        .ootd-calendar-container {
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            background: rgba(255, 255, 255, 0.7);
        }

        .dark .ootd-calendar-container {
            background: rgba(30, 27, 47, 0.7);
        }

        /* Customize FullCalendar Header */
        .fc-toolbar-title {
            font-family: 'Space Grotesk', sans-serif !important;
            font-weight: 700 !important;
            letter-spacing: -0.025em;
        }

        .fc .fc-button {
            border-radius: 0.75rem;
            font-weight: 600;
            text-transform: capitalize;
            padding: 0.5rem 1.25rem;
            transition: all 0.2s;
            box-shadow: 0 4px 6px -1px rgba(139, 92, 246, 0.2);
        }

        .fc .fc-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 6px 8px -1px rgba(139, 92, 246, 0.3);
        }

        /* Today Button - Red Color Gradient */
        .fc .fc-today-button {
            background: linear-gradient(135deg, #EF4444 0%, #DC2626 100%) !important;
            border: none !important;
            opacity: 1 !important;
        }

        .fc .fc-today-button:hover {
            background: linear-gradient(135deg, #DC2626 0%, #B91C1C 100%) !important;
        }

        /* Equal width for right-side buttons (ìº˜ë¦°ë”, OOTD ëª©ë¡) */
        .fc .fc-dayGridMonth-button,
        .fc .fc-listWeek-button {
            min-width: 80px !important;
            text-align: center;
            white-space: nowrap !important;
            padding: 0.4rem 0.8rem !important;
        }

        .fc-daygrid-day-number {
            font-family: 'Space Grotesk', sans-serif;
            font-weight: 500;
            padding: 8px !important;
            color: #4B5563;
        }

        .dark .fc-daygrid-day-number {
            color: #D1D5DB;
        }

        .fc-col-header-cell-cushion {
            padding: 12px !important;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.05em;
        }

        /* Events Styling */
        .fc-event {
            border-radius: 6px;
            border: none;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
            transition: transform 0.2s;
            cursor: pointer;
        }

        .fc-event:hover {
            transform: scale(1.02);
            z-index: 5;
        }

        /* Layout Utilities */
        .ootd-page-body {
            overflow-x: hidden;
            background-image:
                radial-gradient(circle at 10% 20%, rgba(139, 92, 246, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(236, 72, 153, 0.05) 0%, transparent 20%);
            background-attachment: fixed;
        }

        .ootd-main {
            min-height: calc(100vh - 80px);
            padding-top: 80px;
        }

        .ootd-content {
            min-height: calc(100vh - 80px);
            display: flex;
            flex-direction: column;
        }

        .ootd-calendar-section,
        .ootd-fitting-section {
            height: calc(100vh - 180px);
            min-height: 600px;
        }

        .ootd-calendar-container,
        .fitting-container {
            height: 100%;
        }

        /* Mobile Optimization Media Queries */
        @media (max-width: 1024px) {
            .ootd-main {
                padding-top: 60px;
                /* Smaller header padding */
            }

            .ootd-calendar-section {
                height: auto;
                min-height: 600px;
                /* Allow scroll on mobile */
            }

            .ootd-fitting-section {
                height: auto;
                min-height: auto;
                /* Allow natural flow */
            }

            .fitting-container {
                flex-direction: column;
                height: auto;
                gap: 2rem;
            }

            /* Stacked Layout Heights */
            #mannequin-container {
                min-height: 500px;
                /* Canvas height on mobile */
            }

            .spotlight-beam {
                height: 180px;
                /* Shorter beams */
            }

            /* Adjust Wardrobe Height when stacked */
            .lg\:w-1\/4 {
                width: 100%;
                height: 500px;
                /* Fixed height for wardrobe on mobile */
            }

            /* FullCalendar Mobile Tweaks */
            .fc-toolbar-title {
                font-size: 1.1rem !important;
            }

            .fc .fc-button {
                padding: 0.25rem 0.6rem !important;
                font-size: 0.75rem !important;
            }

            .fc-col-header-cell-cushion {
                font-size: 0.75rem !important;
                padding: 4px !important;
            }

            .fc-daygrid-day-number {
                font-size: 0.75rem !important;
                padding: 4px !important;
            }
        }

        /* Flexfixes for calendar */
        .ootd-calendar-container #calendar {
            flex: 1;
            min-height: 0;
        }

        .fc {
            height: 100% !important;
        }

        .fc .fc-view-harness {
            height: calc(100% - 60px) !important;
        }

        /* Studio Spotlights - Warm Yellow */
        .spotlight-fixture {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-top: -5px;
            /* Adjust position */
            position: relative;
            z-index: 20;
            filter: drop-shadow(0 0 5px rgba(234, 179, 8, 0.3));
        }

        .spotlight-body {
            width: 34px;
            height: 24px;
            background: linear-gradient(135deg, #1f2937 0%, #000 100%);
            border-radius: 6px 6px 12px 12px;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.5), inset 0 1px 1px rgba(255, 255, 255, 0.1);
            position: relative;
            border: 1px solid #374151;
        }

        .spotlight-body::after {
            content: '';
            position: absolute;
            bottom: -6px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            background: radial-gradient(ellipse, #fff 10%, #fbbf24 50%, transparent 70%);
            border-radius: 50%;
            box-shadow: 0 0 20px 5px rgba(251, 191, 36, 0.6);
            filter: blur(1px);
        }

        .spotlight-beam {
            width: 100px;
            height: 250px;
            background: linear-gradient(to bottom,
                    rgba(253, 224, 71, 0.2) 0%,
                    rgba(253, 224, 71, 0.05) 40%,
                    transparent 80%);
            clip-path: polygon(35% 0%, 65% 0%, 100% 100%, 0% 100%);
            margin-top: -5px;
            filter: blur(8px);
            pointer-events: none;
            transform-origin: top center;
            animation: beam-pulse 4s infinite alternate;
        }

        @keyframes beam-pulse {
            0% {
                opacity: 0.7;
                transform: scaleY(1);
            }

            100% {
                opacity: 1;
                transform: scaleY(1.05);
            }
        }
    </style>

    <!-- ì¹´í…Œê³ ë¦¬ í•„í„° ì „ì—­ í•¨ìˆ˜ (ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ë³´ë‹¤ ë¨¼ì € ë¡œë“œ) -->
    <script>
        // ì „ì—­ ë³€ìˆ˜
        var selectedCategory = 'ì „ì²´';
        var wardrobeData = [];

        // ì¹´í…Œê³ ë¦¬ í•„í„° í•¨ìˆ˜
        function filterCategory(category, btnElement) {
            selectedCategory = category;

            // ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™” ìŠ¤íƒ€ì¼
            document.querySelectorAll('.category-tab-btn').forEach(function (b) {
                b.classList.remove('text-primary', 'border-b-2', 'border-primary', 'bg-primary/5', 'dark:bg-primary/10', 'dark:text-primary-light');
                b.classList.add('text-gray-500');
            });

            // í´ë¦­í•œ ë²„íŠ¼ í™œì„±í™” ìŠ¤íƒ€ì¼
            if (btnElement) {
                btnElement.classList.remove('text-gray-500');
                btnElement.classList.add('text-primary', 'border-b-2', 'border-primary', 'bg-primary/5', 'dark:bg-primary/10', 'dark:text-primary-light');
            }

            // renderWardrobeItemsê°€ ì •ì˜ë˜ì–´ ìˆìœ¼ë©´ í˜¸ì¶œ
            if (typeof renderWardrobeItems === 'function') {
                renderWardrobeItems();
            }
        }
    </script>

    <main class="ootd-main">
        <!-- OOTD Content Area -->
        <div class="ootd-content max-w-7xl mx-auto px-4 py-4">
            <!-- ìƒë‹¨ íƒ­ ë„¤ë¹„ê²Œì´ì…˜ (Trendy Glass Style) -->
            <div class="flex items-center justify-between mb-8 relative z-10">
                <div
                    class="flex items-center gap-2 p-1.5 bg-white/50 dark:bg-gray-800/50 backdrop-blur-md rounded-2xl border border-white/20 shadow-lg">
                    <button id="tabOotd" onclick="switchTab('ootd')"
                        class="flex items-center gap-2 px-4 py-2 lg:px-6 lg:py-2.5 rounded-xl font-bold font-display transition-all duration-300 text-xs lg:text-sm tracking-wide">
                        <i class="fa-solid fa-calendar-days"></i>
                        OOTD CALENDAR
                    </button>
                    <button id="tabFitting" onclick="switchTab('fitting')"
                        class="flex items-center gap-2 px-4 py-2 lg:px-6 lg:py-2.5 rounded-xl font-bold font-display transition-all duration-300 text-xs lg:text-sm tracking-wide text-gray-500 hover:text-gray-700 dark:text-gray-400 dark:hover:text-gray-200">
                        <i class="fa-solid fa-shirt"></i>
                        FITTING ROOM
                    </button>
                </div>
            </div>

            <!-- 1. OOTD ìº˜ë¦°ë” ì„¹ì…˜ -->
            <div id="calendarSection" class="ootd-calendar-section hidden animate-fade-in">
                <div
                    class="ootd-calendar-container rounded-3xl shadow-2xl border border-white/50 dark:border-gray-700/50 p-6">
                    <div id="calendar"></div>
                </div>

                <!-- ë‚ ì§œë³„ ì½”ë”” ìƒì„¸ ë³´ê¸° ëª¨ë‹¬ -->
                <div id="calendarDetailModal"
                    class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
                    <div
                        class="bg-white dark:bg-card-dark rounded-2xl max-w-lg w-full p-6 shadow-2xl transform transition-all scale-100">
                        <div class="flex justify-between items-center mb-4">
                            <h3 id="calDetailDate" class="text-xl font-bold text-gray-800 dark:text-white"></h3>
                            <button onclick="closeCalDetail()"
                                class="text-gray-400 hover:text-gray-600 text-2xl">&times;</button>
                        </div>
                        <div id="calDetailContent" class="space-y-4">
                            <!-- ì½”ë”” ì´ë¯¸ì§€ê°€ ì—¬ê¸°ì— ë“¤ì–´ê° -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. í”¼íŒ…ë£¸ ì„¹ì…˜ (ê¸°ì¡´ ë©”ì¸) -->
            <div id="fittingSection" class="ootd-fitting-section active">
                <!-- ... ê¸°ì¡´ í”¼íŒ…ë£¸ ë‚´ìš© ... -->
                <div class="fitting-container flex flex-col lg:flex-row gap-4">

                    <!-- ì™¼ìª½: 3D ë§ˆë„¤í‚¹ (ë©”ì¸ ì˜ì—­) -->
                    <div
                        class="lg:w-3/4 w-full relative bg-white rounded-2xl overflow-hidden shadow-2xl border border-gray-200 flex flex-col min-h-[500px] lg:min-h-0">

                        <!-- ìŠ¤íŠœë””ì˜¤ ì¡°ëª… ì˜¤ë²„ë ˆì´ -->
                        <div
                            class="absolute top-0 left-0 right-0 h-16 flex justify-center items-start gap-20 z-20 pointer-events-none">
                            <!-- ì™¼ìª½ ì¡°ëª… -->
                            <div class="spotlight-fixture">
                                <div class="spotlight-body"></div>
                                <div class="spotlight-beam"></div>
                            </div>
                            <!-- ì¤‘ì•™ ì¡°ëª… -->
                            <div class="spotlight-fixture">
                                <div class="spotlight-body"></div>
                                <div class="spotlight-beam"></div>
                            </div>
                            <!-- ì˜¤ë¥¸ìª½ ì¡°ëª… -->
                            <div class="spotlight-fixture">
                                <div class="spotlight-body"></div>
                                <div class="spotlight-beam"></div>
                            </div>
                        </div>

                        <!-- 3D ìº”ë²„ìŠ¤ -->
                        <div id="mannequin-container"
                            class="w-full flex-grow cursor-grab active:cursor-grabbing bg-gradient-to-b from-gray-50 to-white dark:from-gray-900 dark:to-gray-800">
                        </div>

                        <!-- ìƒë‹¨ ì»¨íŠ¸ë¡¤ -->
                        <div class="absolute top-6 right-6 flex gap-3 z-10">
                            <!-- ì €ì¥ ë²„íŠ¼ (ìº˜ë¦°ë” ë“±ë¡) -->
                            <button id="saveToCalendarBtn"
                                class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-gray-700 dark:text-gray-200 px-4 py-2 rounded-xl text-sm font-bold shadow-lg border border-white/20 transition-all hover:bg-white hover:scale-105 flex items-center gap-2 group">
                                <span class="group-hover:text-primary transition-colors"><i
                                        class="fas fa-calendar-check"></i></span>
                                <span>ì €ì¥</span>
                            </button>
                            <!-- ì´ˆê¸°í™” ë²„íŠ¼ -->
                            <button id="resetMannequin"
                                class="bg-white/80 dark:bg-gray-800/80 backdrop-blur-md text-gray-500 hover:text-red-500 px-4 py-2 rounded-xl text-sm font-bold shadow-lg border border-white/20 transition-all hover:bg-white hover:scale-105 flex items-center gap-2">
                                <i class="fas fa-undo"></i>
                            </button>
                        </div>

                        <!-- ... (ì¤‘ëµ) ... -->
                        <!-- í•˜ë‹¨ ì•ˆë‚´ (ì‚­ì œë¨) -->

                        <!-- ë“œë¡­ì¡´ ì˜¤ë²„ë ˆì´ -->
                        <div id="dropZone"
                            class="hidden absolute inset-0 bg-primary/20 backdrop-blur-[2px] border-4 border-primary/50 border-dashed z-20 flex items-center justify-center pointer-events-none transition-all">
                            <div
                                class="bg-primary text-white px-8 py-4 rounded-full font-bold shadow-2xl transform scale-110 flex items-center gap-2 animate-bounce">
                                <i class="fas fa-tshirt text-xl"></i> <span class="text-lg">Drop here to wear</span>
                            </div>
                        </div>
                    </div>

                    <!-- ì˜¤ë¥¸ìª½ ì˜·ì¥ ... -->
                    <div
                        class="lg:w-1/4 w-full flex flex-col bg-white/80 dark:bg-gray-800/80 backdrop-blur-xl rounded-2xl shadow-xl border border-white/40 dark:border-gray-700 overflow-hidden h-[500px] lg:h-auto">
                        <!-- ... ì˜·ì¥ ë‚´ìš© ìƒëµ (ê¸°ì¡´ ìœ ì§€) ... -->
                        <div
                            class="p-4 border-b border-gray-100 dark:border-gray-700 flex justify-between items-center bg-transparent">
                            <div class="flex items-center gap-2">
                                <div
                                    class="w-8 h-8 rounded-full bg-primary/10 flex items-center justify-center text-primary">
                                    <i class="fas fa-door-open text-xs"></i>
                                </div>
                                <h2 class="font-bold text-gray-800 dark:text-gray-100 font-display">ë‚´ ì˜·ì¥</h2>
                            </div>
                            <button id="refreshWardrobe"
                                class="text-gray-400 hover:text-primary transition-colors p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-full">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>

                        <!-- ì¹´í…Œê³ ë¦¬ íƒ­ (ì‹¬í”Œ ë²„ì „) -->
                        <div id="categoryTabs"
                            class="grid grid-cols-4 border-b border-gray-100 dark:border-gray-700 text-xs font-semibold tracking-wide">
                            <button onclick="filterCategory('ì „ì²´', this)"
                                class="category-tab-btn p-3 text-primary border-b-2 border-primary bg-primary/5 dark:bg-primary/10 dark:text-primary-light transition-colors"
                                data-category="ì „ì²´">ì „ì²´</button>
                            <button onclick="filterCategory('ìƒì˜', this)"
                                class="category-tab-btn p-3 text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                data-category="ìƒì˜">ìƒì˜</button>
                            <button onclick="filterCategory('í•˜ì˜', this)"
                                class="category-tab-btn p-3 text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                data-category="í•˜ì˜">í•˜ì˜</button>
                            <button onclick="filterCategory('ì•„ìš°í„°', this)"
                                class="category-tab-btn p-3 text-gray-500 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors"
                                data-category="ì•„ìš°í„°">ì•„ìš°í„°</button>
                        </div>

                        <!-- ì˜· ëª©ë¡ (ìŠ¤í¬ë¡¤ ì˜ì—­) -->
                        <div
                            class="flex-1 overflow-y-auto custom-scrollbar p-3 bg-gray-50 dark:bg-gray-900/30 relative">
                            <div id="wardrobeGrid" class="grid grid-cols-2 gap-3">
                                <!-- JSë¡œ ë¡œë“œë¨ -->
                            </div>
                            <div id="wardrobeLoading"
                                class="hidden absolute inset-0 flex items-center justify-center bg-white/80 dark:bg-gray-900/80 z-10 backdrop-blur-sm">
                                <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-primary"></div>
                            </div>
                            <div id="emptyWardrobe"
                                class="hidden absolute inset-0 flex flex-col items-center justify-center text-gray-400">
                                <i class="fas fa-box-open text-3xl mb-2 opacity-50"></i>
                                <p class="text-sm">ì˜·ì¥ì´ ë¹„ì–´ìˆì–´ìš”</p>
                            </div>
                        </div>

                        <!-- ì„ íƒëœ ì•„ì´í…œ ì •ë³´ (í•˜ë‹¨ ê³ ì •) -->
                        <div id="selectedItemInfo"
                            class="hidden p-4 border-t border-gray-100 dark:border-gray-700 bg-primary/5 dark:bg-primary/10 flex items-center gap-3 animate-fade-in-up">
                            <div
                                class="w-10 h-10 rounded-lg bg-primary/10 dark:bg-primary/20 flex items-center justify-center text-primary text-lg shadow-sm">
                                <i class="fas fa-check"></i>
                            </div>
                            <div class="flex-1 min-w-0">
                                <p class="text-[10px] text-primary font-bold uppercase tracking-wider mb-0.5">
                                    SELECTED</p>
                                <h3 id="selectedItemName"
                                    class="text-sm font-bold text-gray-800 dark:text-gray-200 truncate font-display">ì•„ì´í…œ
                                    ì´ë¦„</h3>
                                <p id="selectedItemDetail" class="text-xs text-gray-500 truncate">ì¹´í…Œê³ ë¦¬</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>


            <!-- (ê¸°ì¡´ Feed ì„¹ì…˜ì€ ìˆ¨ê¹€ ì²˜ë¦¬ í˜¹ì€ ì‚­ì œ - ìš”ì²­ì‚¬í•­ì—ì„œ ìº˜ë¦°ë”ê°€ ë©”ì¸ì¸ë“¯ í•¨) -->
            <!-- ìº˜ë¦°ë” ì €ì¥ ëª¨ë‹¬ -->
            <div id="saveToPropModal"
                class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
                <div class="bg-white dark:bg-card-dark rounded-2xl max-w-md w-full p-6 shadow-2xl animate-fade-in-up">
                    <h3 class="text-xl font-bold mb-4"><i class="fa-solid fa-calendar-days mr-2 text-gray-600"></i>OOTD
                        ìº˜ë¦°ë” ì €ì¥</h3>

                    <div class="mb-4">
                        <img id="savePreviewImg" src=""
                            class="w-full h-48 object-contain bg-gray-100 rounded-lg border border-gray-200">
                    </div>

                    <div class="mb-4">
                        <label class="block text-sm font-bold text-gray-700 mb-1">ë‚ ì§œ ì„ íƒ</label>
                        <input type="date" id="ootdDateInput"
                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all">
                    </div>

                    <div class="mb-6">
                        <label class="block text-sm font-bold text-gray-700 mb-1">ë©”ëª¨ (ì„ íƒ)</label>
                        <textarea id="ootdMemoInput"
                            class="w-full border border-gray-300 rounded-lg p-2 focus:ring-2 focus:ring-primary focus:border-transparent outline-none transition-all"
                            placeholder="ì˜ˆ: ë°ì´íŠ¸ë£©, ì¶œê·¼ë£© ë“±"></textarea>
                    </div>

                    <div class="flex gap-2">
                        <button onclick="document.getElementById('saveToPropModal').classList.add('hidden')"
                            class="flex-1 bg-gray-100 text-gray-700 py-3 rounded-xl font-bold hover:bg-gray-200 transition-colors">ì·¨ì†Œ</button>
                        <button id="confirmSaveOotd"
                            class="flex-1 bg-primary text-white py-3 rounded-xl font-bold hover:bg-primary-light shadow-lg shadow-primary/30 transition-all transform hover:scale-105">ì €ì¥í•˜ê¸°</button>
                    </div>
                </div>
            </div>

            <!-- FullCalendar CSS/JS Load -->
            <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js'></script>
            <script>
                // íƒ­ ì „í™˜ ë¡œì§
                function switchTab(tab) {
                    const ootdTab = document.getElementById('tabOotd');
                    const fittingTab = document.getElementById('tabFitting');
                    const calendarSec = document.getElementById('calendarSection');
                    const fittingSec = document.getElementById('fittingSection');

                    if (tab === 'ootd') {
                        // OOTD Active Style
                        ootdTab.classList.add('bg-primary', 'text-white', 'shadow-md');
                        ootdTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');

                        // Fitting Inactive
                        fittingTab.classList.add('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');
                        fittingTab.classList.remove('bg-primary', 'text-white', 'shadow-md');

                        // ì„¹ì…˜ ì „í™˜
                        calendarSec.classList.remove('hidden');
                        fittingSec.classList.add('hidden');

                        // ìº˜ë¦°ë” ë¦¬ë Œë”ë§
                        setTimeout(() => { if (calendar) calendar.render(); }, 100);

                    } else {
                        // Fitting Active Style
                        fittingTab.classList.add('bg-primary', 'text-white', 'shadow-md');
                        fittingTab.classList.remove('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');

                        // OOTD Inactive
                        ootdTab.classList.add('text-gray-500', 'hover:text-gray-700', 'dark:text-gray-400');
                        ootdTab.classList.remove('bg-primary', 'text-white', 'shadow-md');

                        calendarSec.classList.add('hidden');
                        fittingSec.classList.remove('hidden');

                        // ë§ˆë„¤í‚¹ ë¦¬ì‚¬ì´ì¦ˆ
                        setTimeout(() => {
                            if (mannequin) mannequin.resize();
                        }, 50);
                    }
                }

                // ìº˜ë¦°ë” ê´€ë ¨ ë³€ìˆ˜ ë° ì´ˆê¸°í™”
                let calendar = null;
                const OOTD_STORAGE_KEY = 'rebirth_ootd_calendar_data';

                document.addEventListener('DOMContentLoaded', () => {
                    // 1. ìº˜ë¦°ë” ì´ˆê¸°í™”
                    const calendarEl = document.getElementById('calendar');
                    calendar = new FullCalendar.Calendar(calendarEl, {
                        initialView: 'dayGridMonth',
                        locale: 'ko',
                        headerToolbar: {
                            left: 'prev,next today',
                            center: 'title',
                            right: 'dayGridMonth,listWeek'
                        },
                        buttonText: {
                            today: 'This Month',
                            month: 'ìº˜ë¦°ë”',
                            list: 'OOTD ëª©ë¡'
                        },
                        allDayText: 'OOTD',
                        events: function (info, successCallback, failureCallback) {
                            fetch('/api/ootd/calendar/list')
                                .then(response => response.json())
                                .then(result => {
                                    if (result.success) {
                                        const events = result.data.map(item => ({
                                            id: item.id, // DB ID
                                            title: item.title,
                                            start: item.eventDate,
                                            allDay: true,
                                            extendedProps: {
                                                // VOì˜ í•„ë“œëª…ì€ imageBase64ì´ë‚˜ JSON ë³€í™˜ ì‹œ imageBase64ë¡œ ì˜´
                                                image: item.imageBase64,
                                                description: item.title
                                            }
                                        }));
                                        successCallback(events);
                                    } else {
                                        console.error('ìº˜ë¦°ë” ë¡œë“œ ì‹¤íŒ¨:', result.message);
                                        failureCallback(result.message);
                                    }
                                })
                                .catch(err => {
                                    console.error(err);
                                    failureCallback(err);
                                });
                        },
                        // ì´ë²¤íŠ¸ ì»¤ìŠ¤í…€ ë Œë”ë§ (ì´ë¯¸ì§€ ë¯¸ë¦¬ë³´ê¸° ì¶”ê°€)
                        eventContent: function (arg) {
                            let props = arg.event.extendedProps;
                            let container = document.createElement('div');
                            container.className = 'flex items-center gap-2 overflow-hidden';

                            // ì´ë¯¸ì§€ ìˆìœ¼ë©´ ì¶”ê°€
                            if (props.image) {
                                let img = document.createElement('img');
                                img.src = props.image;
                                img.className = 'w-8 h-8 rounded-md object-contain bg-white border border-gray-200';
                                container.appendChild(img);
                            }

                            let title = document.createElement('div');
                            title.innerText = arg.event.title;
                            title.className = 'text-sm font-medium truncate';
                            container.appendChild(title);

                            return { domNodes: [container] };
                        },
                        eventClick: function (info) {
                            showEventDetail(info.event);
                        },
                        dayMaxEvents: true // ì´ë²¤íŠ¸ ë§ìœ¼ë©´ +more í‘œì‹œ
                    });
                    calendar.render();

                    // 2. ì €ì¥ ë²„íŠ¼ ë¦¬ìŠ¤ë„ˆ (ê¸°ì¡´ screenshotBtnì€ ì´ë¯¸ì§€ ë‹¤ìš´ë¡œë“œìš©ìœ¼ë¡œ ë†”ë‘ê±°ë‚˜ ë³€ê²½)
                    // ìƒˆë¡œ ë§Œë“  saveToCalendarBtn ì‚¬ìš©
                    const btn = document.getElementById('saveToCalendarBtn');
                    if (btn) {
                        btn.addEventListener('click', () => {
                            if (mannequin) {
                                mannequin.takeScreenshotBlob().then(blob => {
                                    const reader = new FileReader();
                                    reader.onloadend = () => {
                                        document.getElementById('savePreviewImg').src = reader.result;
                                        document.getElementById('ootdDateInput').valueAsDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸
                                        document.getElementById('saveToPropModal').classList.remove('hidden');
                                    };
                                    reader.readAsDataURL(blob);
                                });
                            }
                        });
                    }

                    // 3. ëª¨ë‹¬ ì €ì¥ í™•ì¸ ë²„íŠ¼
                    document.getElementById('confirmSaveOotd').addEventListener('click', saveOotdToCalendar);

                    // ì´ˆê¸° íƒ­ ì„¤ì • (OOTD íƒ­ì´ ê¸°ë³¸)
                    switchTab('ootd');

                    // ìº˜ë¦°ë” ì´ˆê¸° ë Œë”ë§ ë¬¸ì œ í•´ê²° - ì•½ê°„ì˜ ë”œë ˆì´ í›„ ë‹¤ì‹œ ë Œë”ë§
                    setTimeout(() => {
                        if (calendar) {
                            calendar.updateSize();
                            calendar.render();
                        }
                    }, 200);
                });

                // ë” ì´ìƒ ì‚¬ìš©í•˜ì§€ ì•ŠìŒ (API ëŒ€ì²´ë¨)
                // function loadEventsFromStorage() { ... }
                // function saveEventsToStorage(events) { ... }

                // ì„ì‹œ showToast í•¨ìˆ˜ (ì‹¤ì œ êµ¬í˜„ì€ ë³„ë„ íŒŒì¼ì— ìˆì„ ìˆ˜ ìˆìŒ)
                function showToast(message) {
                    alert(message);
                }

                async function saveOotdToCalendar() {
                    const date = document.getElementById('ootdDateInput').value;
                    const title = document.getElementById('ootdMemoInput').value;

                    // ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ì—ì„œ Base64 ì§ì ‘ ê°€ì ¸ì˜¤ê¸° (ê°€ì¥ í™•ì‹¤í•œ ë°©ë²•!)
                    const imageBase64 = document.getElementById('savePreviewImg').src;

                    if (!date) { showToast('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”!'); return; }

                    const eventData = {
                        eventDate: date,
                        title: title || 'ë‚˜ì˜ OOTD', // ë©”ëª¨ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’
                        imageBase64: imageBase64   // ë¯¸ë¦¬ë³´ê¸°ì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´
                    };

                    // API í˜¸ì¶œ
                    fetch('/api/ootd/calendar/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(eventData)
                    })
                        .then(res => res.json())
                        .then(data => {
                            if (data.success) {
                                showToast('ğŸ“… ìº˜ë¦°ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                                document.getElementById('saveToPropModal').classList.add('hidden');
                                calendar.refetchEvents(); // ìº˜ë¦°ë” ìƒˆë¡œê³ ì¹¨

                                // íƒ­ ì´ë™
                                switchTab('ootd');
                            } else {
                                alert('ì €ì¥ ì‹¤íŒ¨: ' + data.message);
                            }
                        })
                        .catch(err => {
                            console.error(err);
                            alert('ì„œë²„ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                        });
                }

                // Blob -> Base64 ë³€í™˜ í—¬í¼
                function blobToBase64(blob) {
                    return new Promise((resolve, reject) => {
                        const reader = new FileReader();
                        reader.onloadend = () => resolve(reader.result);
                        reader.onerror = reject;
                        reader.readAsDataURL(blob);
                    });
                }

                function showEventDetail(event) {
                    const dateStr = event.start.toLocaleDateString('ko-KR', { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' });
                    document.getElementById('calDetailDate').innerText = dateStr;

                    const contentInfo = document.getElementById('calDetailContent');
                    contentInfo.innerHTML = `
                         <div class="relative rounded-xl overflow-hidden bg-gray-100 mb-4 border border-gray-200">
                            <img src="${event.extendedProps.image}" class="w-full object-contain max-h-[400px]">
                         </div>
                         <div class="bg-gray-50 p-4 rounded-lg">
                            <h4 class="font-bold text-gray-700 mb-1">ğŸ“ ë©”ëª¨</h4>
                            <p class="text-gray-600">${event.title || 'ë©”ëª¨ ì—†ìŒ'}</p>
                         </div>
                         <div class="flex justify-end mt-4">
                            <button onclick="deleteEvent('${event.id}')" class="text-red-500 hover:text-red-700 text-sm underline">ì´ ê¸°ë¡ ì‚­ì œí•˜ê¸°</button>
                         </div>
                    `;

                    document.getElementById('calendarDetailModal').classList.remove('hidden');
                }

                function closeCalDetail() {
                    document.getElementById('calendarDetailModal').classList.add('hidden');
                }

                function deleteEvent(eventId) {
                    if (confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        fetch(`/api/ootd/calendar/${eventId}`, {
                            method: 'DELETE'
                        })
                            .then(res => res.json())
                            .then(data => {
                                if (data.success) {
                                    const eventObj = calendar.getEventById(eventId);
                                    if (eventObj) eventObj.remove(); // ìº˜ë¦°ë” UIì—ì„œ ì œê±°
                                    showToast('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                                    document.getElementById('calendarDetailModal').classList.add('hidden');
                                } else {
                                    alert('ì‚­ì œ ì‹¤íŒ¨: ' + data.message);
                                }
                            })
                            .catch(e => alert('ì˜¤ë¥˜ ë°œìƒ'));
                    }
                }
            </script>
    </main>

    <!-- OOTD ê³µìœ  ëª¨ë‹¬ -->
    <div id="shareModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-card-dark rounded-2xl max-w-md w-full p-6 shadow-2xl">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-lg font-bold">OOTD ê³µìœ í•˜ê¸°</h3>
                <button id="closeModal" class="text-gray-400 hover:text-gray-600 text-xl">&times;</button>
            </div>
            <div class="mb-4">
                <img id="previewImage" src="" alt="OOTD Preview"
                    class="w-full h-48 object-contain bg-gray-100 dark:bg-gray-800 rounded-lg">
            </div>
            <div class="space-y-3">
                <div>
                    <label class="block text-sm font-medium mb-1">ì œëª©</label>
                    <input type="text" id="ootdTitle" placeholder="ì˜¤ëŠ˜ì˜ ì½”ë”” ì œëª©"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700">
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">ì„¤ëª…</label>
                    <textarea id="ootdDescription" placeholder="ì½”ë”” ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”" rows="2"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700"></textarea>
                </div>
                <div>
                    <label class="block text-sm font-medium mb-1">íƒœê·¸</label>
                    <input type="text" id="ootdTags" placeholder="#ìºì£¼ì–¼ #ë°ì¼ë¦¬ #ë´„ì½”ë””"
                        class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700">
                </div>
            </div>
            <div class="flex gap-2 mt-6">
                <button id="cancelShare"
                    class="flex-1 px-4 py-2 bg-gray-200 dark:bg-gray-700 rounded-lg hover:bg-gray-300 dark:hover:bg-gray-600">ì·¨ì†Œ</button>
                <button id="submitShare"
                    class="flex-1 px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:from-indigo-600 hover:to-purple-600">ê³µìœ í•˜ê¸°</button>
            </div>
        </div>
    </div>

    <!-- OOTD ìƒì„¸ ëª¨ë‹¬ -->
    <div id="detailModal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white dark:bg-card-dark rounded-2xl max-w-2xl w-full max-h-[90vh] overflow-y-auto shadow-2xl">
            <div class="relative">
                <img id="detailImage" src="" alt="OOTD"
                    class="w-full aspect-square object-contain bg-gray-100 dark:bg-gray-800">
                <button id="closeDetailModal"
                    class="absolute top-4 right-4 w-10 h-10 bg-black/50 text-white rounded-full flex items-center justify-center hover:bg-black/70 text-xl">&times;</button>
            </div>
            <div class="p-6">
                <div class="flex items-center gap-3 mb-4">
                    <img id="detailUserImage" src="" alt="" class="w-10 h-10 rounded-full bg-gray-200">
                    <div>
                        <p id="detailUserName" class="font-medium">ì‚¬ìš©ì</p>
                        <p id="detailDate" class="text-xs text-gray-500">ë‚ ì§œ</p>
                    </div>
                </div>

                <h3 id="detailTitle" class="text-xl font-bold mb-2">ì œëª©</h3>
                <p id="detailDescription" class="text-gray-600 dark:text-gray-400 mb-4">ì„¤ëª…</p>

                <div id="detailTags" class="flex flex-wrap gap-2 mb-4"></div>

                <div class="flex items-center justify-between border-t dark:border-gray-700 pt-4">
                    <div class="flex items-center gap-4">
                        <button id="likeBtn"
                            class="flex items-center gap-1 text-gray-500 hover:text-red-500 transition-colors">
                            <span id="likeIcon">ğŸ¤</span>
                            <span id="likeCount">0</span>
                        </button>
                        <span class="flex items-center gap-1 text-gray-500">
                            <span>ğŸ’¬</span>
                            <span id="commentCount">0</span>
                        </span>
                        <span class="flex items-center gap-1 text-gray-500">
                            <span>ğŸ‘ï¸</span>
                            <span id="viewCount">0</span>
                        </span>
                    </div>

                    <!-- ê³µìœ  ë²„íŠ¼ë“¤ -->
                    <div class="flex items-center gap-2">
                        <button id="copyLinkBtn" title="ë§í¬ ë³µì‚¬"
                            class="w-9 h-9 rounded-full bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 flex items-center justify-center transition-colors">
                            ğŸ”—
                        </button>
                        <button id="shareKakaoBtn" title="ì¹´ì¹´ì˜¤í†¡ ê³µìœ "
                            class="w-9 h-9 rounded-full bg-yellow-400 hover:bg-yellow-500 flex items-center justify-center transition-colors">
                            ğŸ’¬
                        </button>
                        <button id="shareTwitterBtn" title="íŠ¸ìœ„í„° ê³µìœ "
                            class="w-9 h-9 rounded-full bg-blue-400 hover:bg-blue-500 flex items-center justify-center transition-colors text-white">
                            ğ•
                        </button>
                    </div>
                </div>

                <div class="flex justify-end mt-3">
                    <button id="applyOutfitBtn"
                        class="px-4 py-2 bg-gradient-to-r from-indigo-500 to-purple-500 text-white rounded-lg hover:from-indigo-600 hover:to-purple-600 flex items-center gap-2 transition-all">
                        <span>ğŸ‘—</span> ì´ ì½”ë”” ì ìš©í•˜ê¸°
                    </button>
                </div>

                <!-- ëŒ“ê¸€ ì„¹ì…˜ -->
                <div class="mt-6 border-t dark:border-gray-700 pt-4">
                    <h4 class="font-semibold mb-4 flex items-center gap-2">
                        <span>ğŸ’¬</span> ëŒ“ê¸€ <span id="commentCountLabel"
                            class="text-gray-400 text-sm font-normal">(0)</span>
                    </h4>

                    <!-- ëŒ“ê¸€ ì‘ì„± -->
                    <div class="flex gap-3 mb-4">
                        <input type="text" id="commentInput" placeholder="ëŒ“ê¸€ì„ ì…ë ¥í•˜ì„¸ìš”..."
                            class="flex-1 px-4 py-2 border rounded-full focus:ring-2 focus:ring-indigo-500 dark:bg-gray-800 dark:border-gray-700 text-sm">
                        <button id="submitCommentBtn"
                            class="px-4 py-2 bg-indigo-500 hover:bg-indigo-600 text-white rounded-full text-sm transition-all">
                            ë“±ë¡
                        </button>
                    </div>

                    <!-- ëŒ“ê¸€ ëª©ë¡ -->
                    <div id="commentList" class="space-y-4 max-h-60 overflow-y-auto">
                        <!-- ëŒ“ê¸€ì´ ì—¬ê¸°ì— ë Œë”ë§ë©ë‹ˆë‹¤ -->
                        <p id="noCommentsMsg" class="text-center text-gray-400 text-sm py-4">ì•„ì§ ëŒ“ê¸€ì´ ì—†ìŠµë‹ˆë‹¤. ì²« ëŒ“ê¸€ì„ ë‚¨ê²¨ë³´ì„¸ìš”!
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{fragments/footer :: footerFragment}"></footer>

    <!-- Three.js CDN -->
    <script src="https://unpkg.com/three@0.160.0/build/three.min.js"></script>
    <script src="https://unpkg.com/three@0.160.0/examples/jsm/loaders/GLTFLoader.js" type="module"></script>
    <!-- ì¼ë°˜ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ëª¨ë“ˆì„ ì“°ê¸° ìœ„í•´ importmap ì‚¬ìš© -->
    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>
    <script th:src="@{/js/mannequin3d.js(v=${#dates.createNow().getTime()})}" type="module"></script>

    <style>
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 3px;
        }

        .wardrobe-item {
            transition: all 0.2s ease;
        }

        .wardrobe-item:hover {
            transform: scale(1.05);
        }

        .wardrobe-item.selected {
            box-shadow: 0 0 0 2px #6366f1;
        }

        .ootd-card {
            transition: all 0.3s ease;
        }

        .ootd-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 12px 24px rgba(0, 0, 0, 0.15);
        }
    </style>

    <script>
        const colorNameToHex = {
            'í™”ì´íŠ¸': 0xffffff, 'í°ìƒ‰': 0xffffff, 'white': 0xffffff,
            'ë¸”ë™': 0x000000, 'ê²€ì •': 0x000000, 'black': 0x000000,
            'ë„¤ì´ë¹„': 0x1e3a5f, 'navy': 0x1e3a5f, 'ë¸”ë£¨': 0x3b82f6, 'blue': 0x3b82f6,
            'ë ˆë“œ': 0xef4444, 'red': 0xef4444, 'ê·¸ë¦°': 0x22c55e, 'green': 0x22c55e,
            'í•‘í¬': 0xec4899, 'pink': 0xec4899, 'í¼í”Œ': 0x8b5cf6, 'purple': 0x8b5cf6,
            'ë² ì´ì§€': 0xf5f5dc, 'beige': 0xf5f5dc, 'ë¸Œë¼ìš´': 0x8b4513, 'brown': 0x8b4513,
            'ì¸ë””ê³ ': 0x4f46e5, 'indigo': 0x4f46e5
        };

        const categoryToType = {
            // ìƒì˜
            'ìƒì˜': { part: 'top', type: 'tshirt' },
            'ë°˜íŒ”': { part: 'top', type: 'tshirt' },
            'í‹°ì…”ì¸ ': { part: 'top', type: 'tshirt' },
            'ë°˜íŒ” í‹°ì…”ì¸ ': { part: 'top', type: 'tshirt' },
            'ê¸´íŒ”': { part: 'top', type: 'longsleeve' },
            'ê¸´íŒ” í‹°ì…”ì¸ ': { part: 'top', type: 'longsleeve' },
            'ë§¨íˆ¬ë§¨': { part: 'top', type: 'longsleeve' },
            'í›„ë“œí‹°': { part: 'top', type: 'longsleeve' },
            'ë‹ˆíŠ¸': { part: 'top', type: 'longsleeve' },
            'ì…”ì¸ ': { part: 'top', type: 'longsleeve' },
            'ë¸”ë¼ìš°ìŠ¤': { part: 'top', type: 'tshirt' },
            // í•˜ì˜
            'í•˜ì˜': { part: 'bottom', type: 'pants' },
            'ë°”ì§€': { part: 'bottom', type: 'pants' },
            'ì²­ë°”ì§€': { part: 'bottom', type: 'pants' },
            'ìŠ¬ë™ìŠ¤': { part: 'bottom', type: 'pants' },
            'ì¹˜ë§ˆ': { part: 'bottom', type: 'skirt' },
            'ìŠ¤ì»¤íŠ¸': { part: 'bottom', type: 'skirt' },
            'ë°˜ë°”ì§€': { part: 'bottom', type: 'shorts' },
            'ìˆíŒ¬ì¸ ': { part: 'bottom', type: 'shorts' },
            // ì›í”¼ìŠ¤
            'ì›í”¼ìŠ¤': { part: 'dress', type: 'dress' },
            'ë“œë ˆìŠ¤': { part: 'dress', type: 'dress' },
            // ì‹ ë°œ
            'ì‹ ë°œ': { part: 'shoes', type: 'shoes' },
            'ìŠ¤ë‹ˆì»¤ì¦ˆ': { part: 'shoes', type: 'shoes' },
            'ìš´ë™í™”': { part: 'shoes', type: 'shoes' },
            'êµ¬ë‘': { part: 'shoes', type: 'shoes' },
            'ìŠ¬ë¦¬í¼': { part: 'shoes', type: 'shoes' },
            'ìƒŒë“¤': { part: 'shoes', type: 'shoes' },
            'ë¶€ì¸ ': { part: 'shoes', type: 'shoes' }
        };

        // ì½”ë”” í”„ë¦¬ì…‹
        const outfitPresets = {
            casual: { topType: 'tshirt', bottomType: 'pants', topColor: 0xffffff, bottomColor: 0x1e3a5f, shoeColor: 0xffffff, theme: 'light' },
            formal: { topType: 'longsleeve', bottomType: 'pants', topColor: 0x000000, bottomColor: 0x1e293b, shoeColor: 0x000000, theme: 'dark' },
            date: { topType: 'dress', bottomType: 'skirt', topColor: 0xec4899, bottomColor: 0xec4899, shoeColor: 0xffffff, theme: 'pink' },
            sporty: { topType: 'tshirt', bottomType: 'shorts', topColor: 0xf97316, bottomColor: 0x000000, shoeColor: 0xffffff, theme: 'light' },
            street: { topType: 'longsleeve', bottomType: 'pants', topColor: 0x8b5cf6, bottomColor: 0x000000, shoeColor: 0x000000, theme: 'dark' }
        };

        const themeColors = { dark: 0x1a1a2e, light: 0xf0f0f0, pink: 0xffd1dc, forest: 0x2d5a27 };

        let mannequin = null;
        // wardrobeData, selectedCategoryëŠ” ìƒë‹¨ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì´ë¯¸ ì„ ì–¸ë¨
        let currentOutfit = { topType: 'tshirt', bottomType: 'pants', topColor: '0x4f46e5', bottomColor: '0x1e293b', shoeColor: '0xffffff', backgroundTheme: 'dark' };
        let screenshotDataUrl = null;
        let currentOotdId = null;

        document.addEventListener('DOMContentLoaded', function () {
            try {
                mannequin = initMannequin3D('mannequin-container');
            } catch (error) {
                console.error("ë§ˆë„¤í‚¹ ì´ˆê¸°í™” ì‹¤íŒ¨:", error);
            }
            // mannequin ì´ˆê¸°í™” ì‹¤íŒ¨ì™€ ê´€ê³„ì—†ì´ ì˜·ì¥ì€ ë¡œë“œ ì‹œë„
            loadWardrobe();

            // ë·° í† ê¸€
            document.getElementById('toggleView').addEventListener('click', toggleView);
            document.getElementById('backToFitting').addEventListener('click', () => showSection('fitting'));

            // ìŠ¤í¬ë¦°ìƒ·
            document.getElementById('screenshotBtn').addEventListener('click', () => mannequin?.takeScreenshot());

            // OOTD ê³µìœ 
            document.getElementById('shareOotdBtn').addEventListener('click', openShareModal);
            document.getElementById('closeModal').addEventListener('click', () => document.getElementById('shareModal').classList.add('hidden'));
            document.getElementById('cancelShare').addEventListener('click', () => document.getElementById('shareModal').classList.add('hidden'));
            document.getElementById('submitShare').addEventListener('click', submitOotd);

            // ìƒì„¸ ëª¨ë‹¬
            document.getElementById('closeDetailModal').addEventListener('click', () => document.getElementById('detailModal').classList.add('hidden'));
            document.getElementById('likeBtn').addEventListener('click', toggleLike);
            document.getElementById('applyOutfitBtn').addEventListener('click', applyCurrentOutfit);

            // ì´ˆê¸°í™”
            document.getElementById('refreshWardrobe').addEventListener('click', loadWardrobe);

            // ì˜· ë²—ê¸°ê¸°
            document.getElementById('resetMannequin').addEventListener('click', () => {
                if (mannequin) {
                    try {
                        mannequin.removeAllClothing();
                        showToast('âœ¨ ì˜·ì„ ëª¨ë‘ ë²—ê²¼ìŠµë‹ˆë‹¤.');
                        // ì„ íƒ íš¨ê³¼ ì œê±°
                        document.querySelectorAll('.wardrobe-item').forEach(i => i.classList.remove('selected', 'ring-2', 'ring-indigo-500'));
                        document.getElementById('selectedItemInfo').classList.add('hidden');
                    } catch (e) { console.error(e); }
                }
            });

            // ì„¤ì • ë²„íŠ¼ í† ê¸€
            document.getElementById('settingBtn').addEventListener('click', (e) => {
                e.stopPropagation();
                document.getElementById('settingPopup').classList.toggle('hidden');
            });

            // íŒì—… ë‹«ê¸° (ì™¸ë¶€ í´ë¦­)
            document.addEventListener('click', (e) => {
                const popup = document.getElementById('settingPopup');
                const btn = document.getElementById('settingBtn');
                if (popup && !popup.contains(e.target) && !btn.contains(e.target)) {
                    popup.classList.add('hidden');
                }
            });

            // íšŒì „ ê°ë„ ìŠ¬ë¼ì´ë”
            const angleSlider = document.getElementById('angleSlider');
            const angleValue = document.getElementById('angleValue');

            if (angleSlider) {
                angleSlider.addEventListener('input', function () {
                    const val = parseFloat(this.value);
                    angleValue.textContent = Math.round(val * 100) + '%';
                    if (mannequin) mannequin.setRotationAngle(val);
                });
            }

            // í”„ë¦¬ì…‹
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    applyPreset(this.dataset.preset);
                });
            });

            // ìƒì˜ íƒ€ì…
            document.querySelectorAll('.top-type-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentOutfit.topType = this.dataset.type;
                    mannequin?.setTopType(this.dataset.type);
                    updateTypeButtons('.top-type-btn', this);
                    document.getElementById('bottomSection').style.opacity = this.dataset.type === 'dress' ? '0.3' : '1';
                    document.getElementById('bottomSection').style.pointerEvents = this.dataset.type === 'dress' ? 'none' : 'auto';
                });
            });

            // í•˜ì˜ íƒ€ì…
            document.querySelectorAll('.bottom-type-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentOutfit.bottomType = this.dataset.type;
                    mannequin?.setBottomType(this.dataset.type);
                    updateTypeButtons('.bottom-type-btn', this);
                });
            });

            // ìƒ‰ìƒ ë²„íŠ¼
            setupColorButtons('.top-color-btn', hex => { currentOutfit.topColor = '0x' + hex.toString(16); mannequin?.setTopColor(hex); });
            setupColorButtons('.bottom-color-btn', hex => { currentOutfit.bottomColor = '0x' + hex.toString(16); mannequin?.setBottomColor(hex); });
            setupColorButtons('.shoe-color-btn', hex => { currentOutfit.shoeColor = '0x' + hex.toString(16); mannequin?.setShoeColor(hex); });

            // ë°°ê²½ í…Œë§ˆ
            document.querySelectorAll('.theme-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    currentOutfit.backgroundTheme = this.dataset.theme;
                    mannequin?.setBackgroundColor(themeColors[this.dataset.theme]);
                    document.querySelectorAll('.theme-btn').forEach(b => {
                        b.classList.toggle('border-indigo-500', b === this);
                        b.classList.toggle('border-transparent', b !== this);
                    });
                });
            });
        });

        function updateTypeButtons(selector, active) {
            document.querySelectorAll(selector).forEach(b => {
                b.classList.toggle('bg-indigo-500', b === active);
                b.classList.toggle('bg-white/10', b !== active);
            });
        }

        function setupColorButtons(selector, callback) {
            document.querySelectorAll(selector).forEach(btn => {
                btn.addEventListener('click', function () {
                    callback(parseInt(this.dataset.color));
                    document.querySelectorAll(selector).forEach(b => {
                        b.classList.toggle('border-indigo-400', b === this);
                        b.classList.toggle('border-transparent', b !== this);
                    });
                });
            });
        }

        function applyPreset(presetName) {
            const preset = outfitPresets[presetName];
            if (!preset || !mannequin) return;

            mannequin.setTopType(preset.topType);
            mannequin.setTopColor(preset.topColor);
            if (preset.topType !== 'dress') {
                mannequin.setBottomType(preset.bottomType);
                mannequin.setBottomColor(preset.bottomColor);
            }
            mannequin.setShoeColor(preset.shoeColor);
            mannequin.setBackgroundColor(themeColors[preset.theme]);

            currentOutfit = { ...preset, backgroundTheme: preset.theme };

            // UI ë™ê¸°í™”
            document.querySelectorAll('.top-type-btn').forEach(b => b.classList.toggle('bg-indigo-500', b.dataset.type === preset.topType));
            document.querySelectorAll('.bottom-type-btn').forEach(b => b.classList.toggle('bg-indigo-500', b.dataset.type === preset.bottomType));
            document.querySelectorAll('.theme-btn').forEach(b => b.classList.toggle('border-indigo-500', b.dataset.theme === preset.theme));
        }

        function toggleView() {
            const fittingSection = document.getElementById('fittingRoomSection');
            showSection(fittingSection.classList.contains('hidden') ? 'fitting' : 'feed');
        }

        function showSection(section) {
            const fittingSection = document.getElementById('fittingRoomSection');
            const feedSection = document.getElementById('ootdFeedSection');
            const toggleBtn = document.getElementById('toggleView');

            if (section === 'feed') {
                fittingSection.classList.add('hidden');
                feedSection.classList.remove('hidden');
                toggleBtn.innerHTML = '<span>ğŸ‘—</span> í”¼íŒ…ë£¸ ë³´ê¸°';
                loadOotdFeed();
            } else {
                fittingSection.classList.remove('hidden');
                feedSection.classList.add('hidden');
                toggleBtn.innerHTML = '<span>ğŸ“‹</span> í”¼ë“œ ë³´ê¸°';
            }
        }

        async function loadWardrobe() {
            try {
                document.getElementById('wardrobeLoading').style.display = 'block';
                const response = await fetch('/api/wardrobe/list');
                const result = await response.json();
                if (result.success && result.data) { wardrobeData = result.data; renderWardrobeItems(); }
                else { document.getElementById('wardrobeGrid').innerHTML = '<div class="col-span-2 text-center py-8 text-gray-400 text-sm">ì˜·ì¥ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>'; document.getElementById('emptyWardrobe').classList.remove('hidden'); }
            } catch (e) { document.getElementById('wardrobeGrid').innerHTML = '<div class="col-span-2 text-center py-8 text-gray-400 text-sm">ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤</div>'; }
        }

        function renderWardrobeItems() {
            document.getElementById('wardrobeLoading').style.display = 'none';
            let items = selectedCategory === 'ì „ì²´' ? wardrobeData : wardrobeData.filter(i => (i.category || '').includes(selectedCategory));

            const grid = document.getElementById('wardrobeGrid');
            const emptyState = document.getElementById('emptyWardrobe');

            if (!items.length) {
                grid.innerHTML = '';
                emptyState.classList.remove('hidden');
                return;
            }

            emptyState.classList.add('hidden');
            grid.innerHTML = items.map(item => `
                <div class="wardrobe-item aspect-square rounded-lg overflow-hidden cursor-grab bg-white/10 relative group" 
                     draggable="true"
                     data-id="${item.clothesId}" 
                     data-category="${item.category || ''}" 
                     data-color="${item.color || ''}" 
                     data-name="${item.name || ''}"
                     data-image="${item.imageUrl || ''}">
                    ${item.imageUrl ? `<img src="${item.imageUrl}" class="w-full h-full object-cover pointer-events-none" draggable="false">` : '<div class="w-full h-full flex items-center justify-center text-xl">ğŸ‘•</div>'}
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 flex items-center justify-center transition-opacity">
                        <span class="text-white text-xs text-center px-1">${item.name || item.category}<br><span class="text-xs opacity-70">ë“œë˜ê·¸í•˜ì—¬ ì…íˆê¸°</span></span>
                    </div>
                </div>
            `).join('');

            // ë“œë˜ê·¸ ì´ë²¤íŠ¸ ë°”ì¸ë”©
            document.querySelectorAll('.wardrobe-item').forEach(item => {
                item.addEventListener('dragstart', handleDragStart);
                item.addEventListener('dragend', handleDragEnd);
                // í´ë¦­ìœ¼ë¡œë„ ì…íˆê¸° ê°€ëŠ¥
                item.addEventListener('click', () => applyClothesToMannequin(item));
            });
        }

        // ë“œë˜ê·¸ ì•¤ ë“œë¡­ í•¸ë“¤ëŸ¬
        let draggedItem = null;

        function handleDragStart(e) {
            draggedItem = e.target.closest('.wardrobe-item');
            e.target.classList.add('opacity-50', 'scale-95');
            document.getElementById('dropZone').classList.remove('hidden');

            // ë“œë˜ê·¸ ì´ë¯¸ì§€ ì„¤ì •
            if (e.dataTransfer) {
                e.dataTransfer.effectAllowed = 'copy';
                e.dataTransfer.setData('text/plain', draggedItem.dataset.id);
            }
        }

        function handleDragEnd(e) {
            e.target.classList.remove('opacity-50', 'scale-95');
            document.getElementById('dropZone').classList.add('hidden');
        }

        // ë§ˆë„¤í‚¹ ì»¨í…Œì´ë„ˆ ë“œë¡­ ì´ë²¤íŠ¸
        document.getElementById('mannequin-container').addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'copy';
        });

        document.getElementById('mannequin-container').addEventListener('drop', (e) => {
            e.preventDefault();
            document.getElementById('dropZone').classList.add('hidden');

            if (draggedItem) {
                applyClothesToMannequin(draggedItem);

                // ì…íˆê¸° íš¨ê³¼
                const container = document.getElementById('mannequin-container');
                container.classList.add('ring-4', 'ring-green-500');
                setTimeout(() => container.classList.remove('ring-4', 'ring-green-500'), 500);

                // í† ìŠ¤íŠ¸ í‘œì‹œ
                showToast('âœ¨ ì˜·ì´ ì…í˜€ì¡ŒìŠµë‹ˆë‹¤!');
            }
            draggedItem = null;
        });

        // í˜„ì¬ ì…ì€ ì˜· ì •ë³´ ì €ì¥ (ì´ë¦„ í¬í•¨)
        let wornItems = {};

        function applyClothesToMannequin(el) {
            const category = el.dataset.category;
            const imageUrl = el.dataset.image;
            const name = el.dataset.name;

            // ì¹´í…Œê³ ë¦¬ë¥¼ 3D íŒŒì¸ ë¡œ ë³€í™˜
            const typeInfo = categoryToType[category];
            const part = typeInfo ? typeInfo.part : 'top'; // ê¸°ë³¸ê°’ top

            // í† ê¸€ ê¸°ëŠ¥: ì´ë¯¸ ì„ íƒëœ ì˜·ì„ ë‹¤ì‹œ í´ë¦­í•˜ë©´ ë²—ê¸°ê¸°
            if (el.classList.contains('selected')) {
                el.classList.remove('selected', 'ring-2', 'ring-indigo-500');
                document.getElementById('selectedItemInfo').classList.add('hidden');

                if (mannequin) {
                    // í•´ë‹¹ ì¹´í…Œê³ ë¦¬ ì˜· ë²—ê¸°ê¸°
                    mannequin.removeClothing(part);
                    delete wornItems[part]; // ì •ë³´ ì‚­ì œ
                    showToast(`ğŸ‘• ${name || category} ë²—ê²¼ìŠµë‹ˆë‹¤.`);
                }
                return;
            }

            // ì„ íƒ íš¨ê³¼ (ê°™ì€ ë¶€ìœ„ì˜ ë‹¤ë¥¸ ì˜·ë§Œ ì œê±°)
            document.querySelectorAll('.wardrobe-item').forEach(i => {
                const iCategory = i.dataset.category;
                const iTypeInfo = categoryToType[iCategory];
                const iPart = iTypeInfo ? iTypeInfo.part : 'top';
                // ê°™ì€ íŒŒì¸ (ìƒì˜/í•˜ì˜)ë©´ ì„ íƒ í•´ì œ
                if (iPart === part) {
                    i.classList.remove('selected', 'ring-2', 'ring-indigo-500');
                }
            });
            el.classList.add('selected', 'ring-2', 'ring-indigo-500');

            // ì •ë³´ í‘œì‹œ
            document.getElementById('selectedItemInfo').classList.remove('hidden');
            document.getElementById('selectedItemName').textContent = name || category;
            document.getElementById('selectedItemDetail').textContent = category;

            if (mannequin && imageUrl) {
                // 3D ë§ˆë„¤í‚¹ì— ì…íˆê¸°
                mannequin.wearImage(part, imageUrl);
                wornItems[part] = name || category; // ì •ë³´ ì €ì¥

                showToast(`âœ¨ ${name || category} ì°©ìš© ì™„ë£Œ!`);
            } else if (!imageUrl) {
                showToast('âŒ ì´ë¯¸ì§€ ì •ë³´ê°€ ì—†ëŠ” ì˜·ì…ë‹ˆë‹¤.');
            }
        }

        // ì˜· ë²—ê¸°ê¸° ë²„íŠ¼
        document.getElementById('resetMannequin').addEventListener('click', () => {
            if (mannequin) {
                mannequin.removeAllClothing();
                wornItems = {}; // ì´ˆê¸°í™”
                document.querySelectorAll('.wardrobe-item').forEach(i => i.classList.remove('selected', 'ring-2', 'ring-indigo-500'));
                document.getElementById('selectedItemInfo').classList.add('hidden');
                showToast('ğŸ§ ë§ˆë„¤í‚¹ì´ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
            }
        });

        function openShareModal() {
            if (!mannequin) return;
            mannequin.isDragging = true;
            mannequin.renderer.render(mannequin.scene, mannequin.camera);
            screenshotDataUrl = mannequin.renderer.domElement.toDataURL('image/png');
            mannequin.isDragging = false;
            document.getElementById('previewImage').src = screenshotDataUrl;
            document.getElementById('shareModal').classList.remove('hidden');
        }

        async function submitOotd() {
            const title = document.getElementById('ootdTitle').value.trim();
            if (!title) { alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
            try {
                const response = await fetch('/api/ootd/create', {
                    method: 'POST', headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ title, description: document.getElementById('ootdDescription').value, tags: document.getElementById('ootdTags').value, imageBase64: screenshotDataUrl, ...currentOutfit })
                });
                const result = await response.json();
                if (result.success) { alert('OOTDê°€ ê³µìœ ë˜ì—ˆìŠµë‹ˆë‹¤! ğŸ‰'); document.getElementById('shareModal').classList.add('hidden'); }
                else { alert(result.message || 'ê³µìœ ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.'); }
            } catch (e) { alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'); }
        }

        let currentFeedTab = 'all'; // 'all' or 'my'
        let currentSort = 'latest';
        let allOotdData = [];
        let myOotdData = [];

        async function loadOotdFeed() {
            const grid = document.getElementById('ootdGrid');
            const loading = document.getElementById('ootdLoading');
            const emptyState = document.getElementById('emptyState');

            loading.style.display = 'block';
            emptyState.classList.add('hidden');
            grid.innerHTML = '';
            grid.appendChild(loading);

            try {
                const endpoint = currentFeedTab === 'my' ? '/api/ootd/my' : '/api/ootd/list?limit=50';
                const response = await fetch(endpoint);
                const result = await response.json();
                loading.style.display = 'none';

                if (result.success && result.data?.length) {
                    let data = result.data;

                    // ì •ë ¬ ì ìš©
                    data = sortOotdData(data, currentSort);

                    renderOotdCards(data, grid);
                } else {
                    grid.innerHTML = '';
                    if (currentFeedTab === 'my') {
                        emptyState.classList.remove('hidden');
                    } else {
                        grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500"><p class="text-4xl mb-3">ğŸ“¸</p><p>ì•„ì§ OOTDê°€ ì—†ìŠµë‹ˆë‹¤</p></div>';
                    }
                }
            } catch (e) {
                loading.style.display = 'none';
                grid.innerHTML = '<div class="col-span-full text-center py-12 text-gray-500">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>';
            }
        }

        function sortOotdData(data, sort) {
            switch (sort) {
                case 'popular':
                    return [...data].sort((a, b) => (b.likeCount || 0) - (a.likeCount || 0));
                case 'views':
                    return [...data].sort((a, b) => (b.viewCount || 0) - (a.viewCount || 0));
                case 'latest':
                default:
                    return [...data].sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));
            }
        }

        function renderOotdCards(data, grid) {
            const isMyTab = currentFeedTab === 'my';
            grid.innerHTML = data.map(ootd => `
                <div class="ootd-card bg-white dark:bg-card-dark rounded-xl overflow-hidden shadow-md cursor-pointer relative group" data-id="${ootd.ootdId}">
                    <div class="aspect-square"><img src="${ootd.imageUrl || '/images/placeholder.png'}" alt="${ootd.title}" class="w-full h-full object-cover"></div>
                    <div class="p-3">
                        <p class="font-medium text-sm truncate">${ootd.title || 'ì œëª© ì—†ìŒ'}</p>
                        <div class="flex items-center justify-between mt-2 text-xs text-gray-500">
                            <span>${ootd.userName || 'ìµëª…'}</span>
                            <div class="flex items-center gap-2"><span class="${ootd.liked ? 'text-red-500' : ''}">â¤ï¸ ${ootd.likeCount || 0}</span><span>ğŸ‘ï¸ ${ootd.viewCount || 0}</span></div>
                        </div>
                    </div>
                    ${isMyTab ? `<button class="delete-ootd-btn absolute top-2 right-2 w-8 h-8 bg-red-500/80 hover:bg-red-600 text-white rounded-full opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center" data-id="${ootd.ootdId}" title="ì‚­ì œ">ğŸ—‘ï¸</button>` : ''}
                </div>
            `).join('');

            grid.querySelectorAll('.ootd-card').forEach(card => {
                card.addEventListener('click', (e) => {
                    if (!e.target.classList.contains('delete-ootd-btn')) {
                        openDetailModal(card.dataset.id);
                    }
                });
            });

            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
            grid.querySelectorAll('.delete-ootd-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    e.stopPropagation();
                    if (confirm('ì´ OOTDë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                        await deleteOotd(btn.dataset.id);
                    }
                });
            });
        }

        async function deleteOotd(ootdId) {
            try {
                const response = await fetch(`/api/ootd/${ootdId}`, { method: 'DELETE' });
                const result = await response.json();
                if (result.success) {
                    // í† ìŠ¤íŠ¸ í‘œì‹œ
                    const toast = document.createElement('div');
                    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50';
                    toast.textContent = 'âœ… OOTDê°€ ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.';
                    document.body.appendChild(toast);
                    setTimeout(() => toast.remove(), 2000);

                    loadOotdFeed(); // ìƒˆë¡œê³ ì¹¨
                } else {
                    alert(result.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // íƒ­ ì „í™˜ ì´ë²¤íŠ¸
        document.getElementById('tabAll').addEventListener('click', () => {
            currentFeedTab = 'all';
            document.getElementById('tabAll').classList.add('bg-indigo-500', 'text-white');
            document.getElementById('tabAll').classList.remove('text-gray-300');
            document.getElementById('tabMy').classList.remove('bg-indigo-500', 'text-white');
            document.getElementById('tabMy').classList.add('text-gray-300');
            document.getElementById('emptyState').classList.add('hidden');
            loadOotdFeed();
        });

        document.getElementById('tabMy').addEventListener('click', () => {
            currentFeedTab = 'my';
            document.getElementById('tabMy').classList.add('bg-indigo-500', 'text-white');
            document.getElementById('tabMy').classList.remove('text-gray-300');
            document.getElementById('tabAll').classList.remove('bg-indigo-500', 'text-white');
            document.getElementById('tabAll').classList.add('text-gray-300');
            loadOotdFeed();
        });

        // ì •ë ¬ ë³€ê²½ ì´ë²¤íŠ¸
        document.getElementById('sortSelect').addEventListener('change', (e) => {
            currentSort = e.target.value;
            loadOotdFeed();
        });


        async function openDetailModal(ootdId) {
            currentOotdId = ootdId;
            try {
                const response = await fetch(`/api/ootd/${ootdId}`);
                const result = await response.json();
                if (result.success && result.data) {
                    const o = result.data;
                    document.getElementById('detailImage').src = o.imageUrl || '/images/placeholder.png';
                    document.getElementById('detailUserImage').src = o.userProfileImage || '/images/default-avatar.png';
                    document.getElementById('detailUserName').textContent = o.userName || 'ìµëª…';
                    document.getElementById('detailDate').textContent = o.createdAt ? new Date(o.createdAt).toLocaleDateString('ko-KR') : '';
                    document.getElementById('detailTitle').textContent = o.title || 'ì œëª© ì—†ìŒ';
                    document.getElementById('detailDescription').textContent = o.description || '';
                    document.getElementById('detailTags').innerHTML = (o.tags || '').split(/[,\s]+/).filter(t => t).map(t => `<span class="px-2 py-1 bg-gray-100 dark:bg-gray-700 rounded-full text-xs">${t.startsWith('#') ? t : '#' + t}</span>`).join('');
                    document.getElementById('likeCount').textContent = o.likeCount || 0;
                    document.getElementById('viewCount').textContent = o.viewCount || 0;
                    document.getElementById('likeIcon').textContent = o.liked ? 'â¤ï¸' : 'ğŸ¤';
                    document.getElementById('applyOutfitBtn').dataset.outfit = JSON.stringify({ topType: o.topType, bottomType: o.bottomType, topColor: o.topColor, bottomColor: o.bottomColor, shoeColor: o.shoeColor, backgroundTheme: o.backgroundTheme });
                    document.getElementById('detailModal').classList.remove('hidden');

                    // ëŒ“ê¸€ ë¡œë“œ
                    loadComments(ootdId);
                }
            } catch (e) { console.error(e); }
        }

        // ëŒ“ê¸€ ë¡œë“œ
        async function loadComments(ootdId) {
            try {
                const response = await fetch(`/api/ootd/${ootdId}/comments`);
                const result = await response.json();
                if (result.success) {
                    renderComments(result.data || []);
                    updateCommentCount(result.count || 0);
                }
            } catch (e) { console.error(e); }
        }

        // ëŒ“ê¸€ ë Œë”ë§
        function renderComments(comments) {
            const container = document.getElementById('commentList');
            const noMsg = document.getElementById('noCommentsMsg');

            if (!comments.length) {
                noMsg.style.display = 'block';
                container.innerHTML = '';
                container.appendChild(noMsg);
                return;
            }

            noMsg.style.display = 'none';
            container.innerHTML = comments.map(c => `
                <div class="flex gap-3 comment-item" data-id="${c.commentId}">
                    <img src="${c.userProfileImage || '/images/default-avatar.png'}" alt="" class="w-8 h-8 rounded-full bg-gray-200 flex-shrink-0">
                    <div class="flex-1">
                        <div class="flex items-center gap-2">
                            <span class="font-medium text-sm">${c.userName || 'ìµëª…'}</span>
                            <span class="text-xs text-gray-400">${c.createdAt ? formatTimeAgo(new Date(c.createdAt)) : ''}</span>
                        </div>
                        <p class="text-sm text-gray-700 dark:text-gray-300 mt-1">${escapeHtml(c.content)}</p>
                    </div>
                    <button class="delete-comment-btn text-gray-400 hover:text-red-500 text-xs opacity-0 group-hover:opacity-100 transition-opacity" 
                        data-id="${c.commentId}" title="ì‚­ì œ">ğŸ—‘ï¸</button>
                </div>
            `).join('');

            // ì‚­ì œ ë²„íŠ¼ ì´ë²¤íŠ¸
            container.querySelectorAll('.delete-comment-btn').forEach(btn => {
                btn.addEventListener('click', () => deleteComment(btn.dataset.id));
            });
        }

        // ëŒ“ê¸€ ìˆ˜ ì—…ë°ì´íŠ¸
        function updateCommentCount(count) {
            document.getElementById('commentCount').textContent = count;
            document.getElementById('commentCountLabel').textContent = `(${count})`;
        }

        // ëŒ“ê¸€ ì‘ì„±
        async function submitComment() {
            const input = document.getElementById('commentInput');
            const content = input.value.trim();

            if (!content) {
                input.focus();
                return;
            }

            try {
                const response = await fetch(`/api/ootd/${currentOotdId}/comments`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content })
                });
                const result = await response.json();

                if (result.success) {
                    input.value = '';
                    renderComments(result.data || []);
                    updateCommentCount(result.count || 0);
                } else {
                    alert(result.message || 'ëŒ“ê¸€ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ëŒ“ê¸€ ì‚­ì œ
        async function deleteComment(commentId) {
            if (!confirm('ëŒ“ê¸€ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch(`/api/ootd/${currentOotdId}/comments/${commentId}`, { method: 'DELETE' });
                const result = await response.json();

                if (result.success) {
                    document.querySelector(`.comment-item[data-id="${commentId}"]`)?.remove();
                    updateCommentCount(result.count || 0);
                } else {
                    alert(result.message || 'ì‚­ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (e) { console.error(e); }
        }

        // ì‹œê°„ í¬ë§·
        function formatTimeAgo(date) {
            const now = new Date();
            const diff = Math.floor((now - date) / 1000);

            if (diff < 60) return 'ë°©ê¸ˆ ì „';
            if (diff < 3600) return `${Math.floor(diff / 60)}ë¶„ ì „`;
            if (diff < 86400) return `${Math.floor(diff / 3600)}ì‹œê°„ ì „`;
            if (diff < 604800) return `${Math.floor(diff / 86400)}ì¼ ì „`;
            return date.toLocaleDateString('ko-KR');
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ëŒ“ê¸€ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì¶”ê°€
        document.getElementById('submitCommentBtn').addEventListener('click', submitComment);
        document.getElementById('commentInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') submitComment();
        });

        async function toggleLike() {
            if (!currentOotdId) return;
            try {
                const response = await fetch(`/api/ootd/${currentOotdId}/like`, { method: 'POST' });
                const result = await response.json();
                if (result.success) {
                    document.getElementById('likeIcon').textContent = result.liked ? 'â¤ï¸' : 'ğŸ¤';
                    document.getElementById('likeCount').textContent = result.likeCount;
                }
            } catch (e) { console.error(e); }
        }

        function applyCurrentOutfit() {
            const btn = document.getElementById('applyOutfitBtn');
            const outfit = JSON.parse(btn.dataset.outfit || '{}');
            if (!mannequin || !outfit.topType) return;

            mannequin.setTopType(outfit.topType);
            outfit.topColor && mannequin.setTopColor(parseInt(outfit.topColor));
            if (outfit.topType !== 'dress') {
                outfit.bottomType && mannequin.setBottomType(outfit.bottomType);
                outfit.bottomColor && mannequin.setBottomColor(parseInt(outfit.bottomColor));
            }
            outfit.shoeColor && mannequin.setShoeColor(parseInt(outfit.shoeColor));
            outfit.backgroundTheme && mannequin.setBackgroundColor(themeColors[outfit.backgroundTheme]);

            document.getElementById('detailModal').classList.add('hidden');
            showSection('fitting');

            // ì•Œë¦¼
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-4 py-2 rounded-lg shadow-lg z-50 animate-bounce';
            toast.textContent = 'âœ¨ ì½”ë””ê°€ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤!';
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // ==================== ê³µìœ  ê¸°ëŠ¥ ====================

        let currentOotdData = null; // í˜„ì¬ ìƒì„¸ ë³´ê¸° ì¤‘ì¸ OOTD ë°ì´í„°

        // ë§í¬ ë³µì‚¬
        document.getElementById('copyLinkBtn').addEventListener('click', async () => {
            const shareUrl = `${window.location.origin}/ootd/list?id=${currentOotdId}`;
            try {
                await navigator.clipboard.writeText(shareUrl);
                showToast('ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                // í´ë°±: êµ¬í˜• ë¸Œë¼ìš°ì €ìš©
                const textArea = document.createElement('textarea');
                textArea.value = shareUrl;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                showToast('ğŸ“‹ ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
            }
        });

        // ì¹´ì¹´ì˜¤í†¡ ê³µìœ 
        document.getElementById('shareKakaoBtn').addEventListener('click', () => {
            const title = document.getElementById('detailTitle').textContent || 'ì˜¤ëŠ˜ì˜ ì½”ë””';
            const description = document.getElementById('detailDescription').textContent || 'Re:birth 3D í”¼íŒ…ë£¸ì—ì„œ ë§Œë“  OOTDë¥¼ í™•ì¸í•´ë³´ì„¸ìš”!';
            const imageUrl = document.getElementById('detailImage').src;
            const shareUrl = `${window.location.origin}/ootd/list?id=${currentOotdId}`;

            // ì¹´ì¹´ì˜¤ SDKê°€ ì—†ìœ¼ë©´ ì›¹ ê³µìœ 
            if (typeof Kakao === 'undefined') {
                // ì¹´ì¹´ì˜¤í†¡ ê³µìœ  URL ìŠ¤í‚´
                const kakaoShareUrl = `https://story.kakao.com/share?url=${encodeURIComponent(shareUrl)}`;
                window.open(kakaoShareUrl, '_blank', 'width=600,height=400');
            } else {
                // ì¹´ì¹´ì˜¤ SDK ì‚¬ìš©
                Kakao.Share.sendDefault({
                    objectType: 'feed',
                    content: {
                        title: title,
                        description: description,
                        imageUrl: imageUrl.startsWith('http') ? imageUrl : window.location.origin + imageUrl,
                        link: { mobileWebUrl: shareUrl, webUrl: shareUrl }
                    },
                    buttons: [{ title: 'OOTD ë³´ëŸ¬ê°€ê¸°', link: { mobileWebUrl: shareUrl, webUrl: shareUrl } }]
                });
            }
        });

        // íŠ¸ìœ„í„°(X) ê³µìœ 
        document.getElementById('shareTwitterBtn').addEventListener('click', () => {
            const title = document.getElementById('detailTitle').textContent || 'ì˜¤ëŠ˜ì˜ ì½”ë””';
            const shareUrl = `${window.location.origin}/ootd/list?id=${currentOotdId}`;
            const tweetText = `${title} - Re:birth 3D í”¼íŒ…ë£¸ì—ì„œ ë§Œë“  OOTDë¥¼ í™•ì¸í•´ë³´ì„¸ìš”! ğŸ‘—âœ¨`;

            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=${encodeURIComponent(shareUrl)}`;
            window.open(twitterUrl, '_blank', 'width=600,height=400');
        });

        // í† ìŠ¤íŠ¸ ë©”ì‹œì§€ ìœ í‹¸
        function showToast(message, type = 'success') {
            const colors = {
                success: 'bg-green-500',
                error: 'bg-red-500',
                info: 'bg-blue-500'
            };
            const toast = document.createElement('div');
            toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-4 py-2 rounded-lg shadow-lg z-50`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2000);
        }

        // OOTD ìº˜ë¦°ë” ì €ì¥ í•¨ìˆ˜
        async function saveOotdToCalendar() {
            const dateInput = document.getElementById('ootdDateInput');
            const memoInput = document.getElementById('ootdMemoInput');

            if (!dateInput.value) {
                alert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            // ì…ì€ ì˜· ì •ë³´ ë¬¸ìì—´ ìƒì„±
            const wornItemsList = Object.values(wornItems).filter(item => item).join(', ');
            let title = memoInput.value.trim();

            // ë©”ëª¨ê°€ ì—†ìœ¼ë©´ ì˜· ì´ë¦„ë§Œ, ìˆìœ¼ë©´ (ì˜· ì´ë¦„) ì¶”ê°€
            if (wornItemsList) {
                if (title) {
                    title += ` (${wornItemsList})`;
                } else {
                    title = wornItemsList;
                }
            } else if (!title) {
                title = 'ë‚˜ì˜ ì½”ë””'; // ê¸°ë³¸ê°’
            }

            const btn = document.querySelector('button[onclick="saveOotdToCalendar()"]');
            const originalContent = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ì €ì¥ ì¤‘...';

            try {
                // currentSnapshotBlob ì‚¬ìš© (ì—†ìœ¼ë©´ ë‹¤ì‹œ ìº¡ì²˜)
                let blob = currentSnapshotBlob;
                if (!blob && mannequin) {
                    blob = await mannequin.takeScreenshotBlob();
                }

                // Blob -> Base64
                const reader = new FileReader();
                reader.readAsDataURL(blob);
                reader.onloadend = async () => {
                    const base64data = reader.result;

                    const response = await fetch('/api/ootd/calendar/save', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            title: title,
                            eventDate: dateInput.value, // yyyy-MM-dd
                            imageBase64: base64data
                        })
                    });

                    const result = await response.json();
                    if (result.success) {
                        alert('ğŸ“… ìº˜ë¦°ë”ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                        document.getElementById('saveToPropModal').classList.add('hidden');

                        // ì…ë ¥ ì´ˆê¸°í™”
                        memoInput.value = '';

                        // ìº˜ë¦°ë” íƒ­ìœ¼ë¡œ ì´ë™ ë° ìƒˆë¡œê³ ì¹¨
                        switchTab('ootd');
                        if (calendar) {
                            calendar.refetchEvents();
                        }
                    } else {
                        alert(result.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                    }

                    btn.disabled = false;
                    btn.innerHTML = originalContent;
                };

            } catch (e) {
                console.error(e);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
                btn.disabled = false;
                btn.innerHTML = originalContent;
            }
        }

        // URLì— id íŒŒë¼ë¯¸í„°ê°€ ìˆìœ¼ë©´ í•´ë‹¹ OOTD ìƒì„¸ ì—´ê¸°
        document.addEventListener('DOMContentLoaded', () => {
            const urlParams = new URLSearchParams(window.location.search);
            const ootdId = urlParams.get('id');
            if (ootdId) {
                showSection('feed');
                setTimeout(() => openDetailModal(ootdId), 500);
            }
        });
    </script>

    <!-- ì €ì¥ ëª¨ë‹¬ (ìº˜ë¦°ë” ì—°ë™) -->
    <div id="saveToPropModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div
            class="bg-white rounded-2xl w-full max-w-sm p-6 shadow-2xl transform transition-all scale-100 animate-fade-in-up">
            <h3 class="text-lg font-bold mb-4 flex items-center gap-2 text-gray-800">
                <i class="far fa-calendar-alt text-indigo-500"></i> OOTD ìº˜ë¦°ë” ì €ì¥
            </h3>

            <!-- ë¯¸ë¦¬ë³´ê¸° ì´ë¯¸ì§€ -->
            <div class="mb-4 bg-gray-100 rounded-lg overflow-hidden flex justify-center border border-gray-200">
                <img id="savePreviewImg" src="" alt="preview" class="h-48 object-contain">
            </div>

            <div class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë‚ ì§œ ì„ íƒ</label>
                    <input type="date" id="ootdDateInput"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none transition-shadow">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">ë©”ëª¨ (ì„ íƒ)</label>
                    <textarea id="ootdMemoInput" rows="2"
                        class="w-full border border-gray-300 rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-indigo-500 outline-none resize-none transition-shadow"
                        placeholder="ì˜¤ëŠ˜ì˜ ì½”ë”” ë©”ëª¨..."></textarea>
                </div>
            </div>

            <div class="flex gap-3 mt-6">
                <button onclick="document.getElementById('saveToPropModal').classList.add('hidden')"
                    class="flex-1 py-2.5 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-xl text-sm font-bold transition-colors">
                    ì·¨ì†Œ
                </button>
                <button onclick="saveOotdToCalendar()"
                    class="flex-1 py-2.5 bg-indigo-600 hover:bg-indigo-700 text-white rounded-xl text-sm font-bold shadow-lg shadow-indigo-200 transition-colors flex justify-center items-center gap-2">
                    <i class="fas fa-check"></i> ì €ì¥í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜ (ì¤‘ë³µ ì„ ì–¸ ë°©ì§€)
        if (typeof currentSnapshotBlob === 'undefined') {
            var currentSnapshotBlob = null;
        }

        // ì €ì¥ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸ (ëª¨ë‹¬ ì—´ê¸°)
        document.getElementById('saveToCalendarBtn')?.addEventListener('click', async () => {
            if (!mannequin) return;

            // ë²„íŠ¼ ë¡œë”© íš¨ê³¼
            const btn = document.getElementById('saveToCalendarBtn');
            const originalHtml = btn.innerHTML;
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ìº¡ì²˜ ì¤‘...';

            try {
                // ìŠ¤í¬ë¦°ìƒ· ìº¡ì²˜ (Blob)
                const blob = await mannequin.takeScreenshotBlob();
                currentSnapshotBlob = blob; // ì „ì—­ ë³€ìˆ˜ ì €ì¥

                const url = URL.createObjectURL(blob);
                const previewImg = document.getElementById('savePreviewImg');
                if (previewImg) previewImg.src = url;

                // ë‚ ì§œ ê¸°ë³¸ê°’ (ì˜¤ëŠ˜)
                const dateInput = document.getElementById('ootdDateInput');
                if (dateInput && !dateInput.value) {
                    dateInput.valueAsDate = new Date();
                }

                // ë©”ëª¨ ì…ë ¥ì°½ ì´ˆê¸°í™” (ë¹„ì›Œë‘ê¸°)
                const memoInput = document.getElementById('ootdMemoInput');
                if (memoInput) {
                    memoInput.value = '';
                    memoInput.placeholder = "ì˜ˆ) ê²°í˜¼ì‹ë£©, ë°ì´íŠ¸ë£©...";
                }

                // ëª¨ë‹¬ í‘œì‹œ
                document.getElementById('saveToPropModal').classList.remove('hidden');

            } catch (e) {
                console.error("ìº¡ì²˜ ì‹¤íŒ¨:", e);
                alert("ì´ë¯¸ì§€ ìº¡ì²˜ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
            } finally {
                btn.disabled = false;
                btn.innerHTML = originalHtml;
            }
        });
    </script>

</body>

</html>